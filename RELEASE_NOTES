
v4_?_? (Nov ??, 2001 idlspec2d+idlutils) running on IDL 5.3 - 5.5
v1_? of specflat

Bug fixes to run on IDL 5.5.
Changes to how the SOS robot launches the rsync jobs and fix other SOS bugs.
Bias-subtraction now implemented (bias images in the "specflat" product).
New set of templates for P-1D; QSO's now use 4 eigentemplates.

APO_LOG2HTML,APOREDUCE: Switch from saving the Mountain standard time (MST)
            string to only storing TAI time, and computing UT on-the-fly.
APO_LOG2HTML: Compare the exposure "flavor" when looking at the operational
           limits (in the "opLimits.par" file).  This allows us to
           differentiate between bias and dark levels (PR #2562).
APOREDUCE: Allow setting MINEXP to 0 sec.  Change default of MINEXP to 0 sec,
           so that any exposure with non-negative exposure time is reduced
           by Son-of-Spectro.
DANVB_CONVERT,DANVB_QSOLIST: Procs for generating a list of input
            QSO's from Dan van den Berk's EDR list "plateEDR.summ"
            for generating QSO eigenvectors.  The output file
            "eigeninput_qso.dat" is then used by PCA_QSO.
FIND_NMINIMA: Retain each peak only if it is at least MINSEP from all
            previous peaks.
FINDSPEC: Crash if the plate list file is missing w/ an informative message.
            Do not crash if spPlate files missing for some plates.
FITARCIMAGE: Bug fix to prevent IDL 5.5 from crashing.
PCA_CVSTAR: New proc for generating eigen-spectra for CV stars.
PCA_QSO: Major re-write now that we're trying to use the eigen-spectra
            from this routine for the redshift-finding code, rather
            than using the single QSO template that we've used to date.
            Solve for 4 eigencomponents in rest-frame [460,9300] Ang.
            Try solving for one eigen-component at a time.  When I tried
            solving for them all simultaneously, this resulted in an
            unphysical 1st eigencomponent, probably because each spectrum
            only covers a small range of rest wavelength.
            Also, make some plots.
PCA_SOLVE: Add NRETURN keyword for returning a different number of
            eigen-components from the number used (NKEEP) for replacing
            bad and noisy data points.  Optionally return NEWFLUX,NEWIVAR.
PCA_STAR: Major changes to read stellar classes and subclasses,
          then generate the 2-component PCA solution for all M stars
          (for example) and reconstruct types M1 through M9.
PLATELIST: Add NEXP,EXPT_B1,EXPT_B2,EXPT_R1,EXPT_R2 to output structure.
PLOTSN: Changed auto-scaling of fitted magnitudes, when less than 20 objects
            are in the desired range.  Now the fitting range will expand to
            [10.0, snmag + 1.0].  So in case of g' [10.0, 21.2], this should
            work much better for the photo-z S/N estimates.
QUICKBIAS: Remove message which preempts logging.  Instead, return a
            set of precentiles that are all -9999, which shows up as ****
            in the HTML file.
REDMONSTER: Change the warning message to "Bad sky residuals...",
            and only send the message "Red Monster at..." if it
            is around 6400-6600 Ang, where we think the problem may
            be due to the hand-paddle LED.  This change is for the
            benefit of the observers (from Son-of-Spectro warnings).
            Also output the peak chi.
REDMONSTERLIST: New procedure: List of number of galaxies and quasars per
            plate, the number of redshifts that differ from prior reductions,
            and the fraction of various 2D flags set.
REMOVE2TODO: Make more robust, and give more descriptive messages.
SDSS_FLAGS: Add "SOUTHERN_SURVEY" flags for TARGET and TTARGET.
            Also, return a warning message for any bits that are set
            but whose meaning is unknown.  Previously, a wrong answer
            would just be given in that case.
SDSSPROC: Reverted to calls to specflat_version,speclog_version that work.
            New option /APPLYBIAS to bias-subtract.
SPBIASAVE: New routine to average biases already generated with SPBIASGEN.
SPPLAN2D: Change the default of MINEXP to 1 sec, so that special plates
            like the M67 plate (#321) will be reduced.
SMOOTH_SUPERFLAT: Located the spurious WARNING, changed to Warning, and
            upped the threshold.  It was not the critical one of the two
            smooth_superflat warnings.
SPBIASGEN: New routine for generating mean biases for a night.
SPCALIB,SPFLATTEN2,SPREDUCE: Use /APPLYBIAS option in call to SDSSPROC.
SPFLATGEN: Add optional keywords EXPNUM,EXPSTART,EXPEND.
SPREDUCE1D, ZFIND, ZCOMPUTE, FIND_NMINIMA: Plotting and debugging
            tools added with the /DOPLOT, /DEBUG keywords.
SPREDUCE1D: Change flag for small chi^2 difference to be triggered
            when RCHI2DIFF < 0.01 or when RCHI2DIFF < 0.01 * RCHI2.
            This means that the difference in reduced chi^2 should be at
            least 0.01 if chi^2/DOF=1, or at least 0.10 if chi^2/DOF=10.
            Print the versions of idlspec2d,idlutils in the log file.
            If the outputs spZall,spZbest files already exist, then rename
            those files rather than destructively over-writing them (using
            CPBACKUP).
            Added search for CV's using the eigenfile 'spEigenCVstar-*.fits'.
            Search for QSO's out to z=7.0, but this will require templates
            that span [525,9300] Ang.
ZCOMPUTE, FIND_NMINIMA: Return a (negative-valued) error code
            from FIND_NMINIMA, which ZCOMPUTE stuffs into Z_ERR.
ZFIND: If fewer than NFIND peaks are found, then return blank structures
            for the remaining (NFIND-NPEAK).  Previously, some of those
            fields (such as TFILE,TCOLUMN) were filled with information.

aporsync.sh: Keep archiving guider images (gzipped).
aporsync.sh: Only copy the following select set of files:
             Unplugged*.ps, fiberScan*.par, guiderMon*.par, op*.par,
             plPlugMap*.par, sdReport*.par
aporsync.sh, sprobot.sh, sprobot1d.sh, sprobot2d.sh:
             Log the UID and PPID (parent process ID) to the file "sos.log",
             and record the timestamp both when this script is launched
             and finishes.
aporsync_logs.sh, aporsync_blue.sh, aporsync_red.sh:
             New scripts called from "sos.sh" instead of "aporsync.sh".
             This should be more robust, and prevent the logging+guider
             files from hanging up the whole system.
sos.sh, sos_status, startapo.sh: Use the new aporync scripts.
eigeninput_cvstar.dat: New file for PCA_CVSTAR.
eigeninput_star.dat: Many more M stars added for implementing changes
            to PCA_STAR.
opHdrFix.par: Correct some values for TILEID,RADEG,DECDEG for the early plates
            187, 202 and 214.
sos_redo: Don't allow this to be run from the machine sdsshost!
sprobot_start: Copy the data over starting at 10am Princeton time,
            which will be after "mailhtml.sh" is run at APO (at 7:20 am).

YANNY_PAR (in idlutils): Add INDX keyword, and fix bug in returned COUNT.
         Support for KEYNAME input as an array.
evilinstall (in idlutils): If $CVSROOT is not set, then set it either
         by setting up the "sdsscvs" product or explicitly setting to the
         Fermi CVS location.  This allows the option of installing from a
         different repository (i.e., Princeton or NYU) by setting $CVSROOT
         first.

-------------------------------------------------------------------------------
v4_8_4 (Aug 29, 2001 idlspec2d+idlutils) running on IDL 5.3 - 5.4

Minor fix to 2D-combining code for running plates 214,340,270 which failed.

MYFLUXCALIB: Fix bug whereby the PCA spectrum could be negative.
     (The routine PCA_SOLVE() can return a negative-valued spectrum even
     if all the input spectra are positive-valued.)  This crashed plate 340.
PCA_SOLVE: Forgot to return optional outputs OUTMASK, USEMASK in the case
           of only a single spectrum being passed.  This happened in the
           combining of plate 214 in MYFLUXCALIB, and crashed.
SDSSPROC: Prevent dividing-by-zero when using /APPLYPIXFLAT,
          though the resulting NaN's had been caught and replaced anyway.
SPREDUCE1D: The outputs ANYANDMASK,ANYORMASK were not being constructed
            properly, and were simply wrong.  Should be fixed now.
sprobot,sprobot_start: Scripts now use the environment variables
          SPROBOT_HOST,SPROBOT_LOCALDISKS for telling which machine to copy
          the raw data from, and which local disks to write to.
          These scripts are now generalized to the point where they can
          be run from anywhere by just setting up environment variables.
spChunkList.par: Update chunk list for chunks 20-25 (up to plate 769).

BSPLINE_BKPTS (in idlutils): Do not crash even in the case of very few
         data points.  But untested whether this actually does what we want
         in that case.
BSPLINE_ITERFIT (in idlutils): Return cleanly in the case of no un-masked
         data points.
eviltarball (in idlutils): New script to export a version of a code
         and build a tar file for distribution.

-------------------------------------------------------------------------------
v4_8_3 (Aug 24, 2001 idlspec2d+idlutils) running on IDL 5.3 - 5.4

Cut version for running P-1D, improving the redshift fits + errors.

BATCH1D,BATCH2D: Added /CLOBBER option to reduce all specified plates,
         over-writing any previous reductions.
BATCH2D: Enabled keywords PLATESTART,PLATEEND,MJD,MJSTART,MJEND.
         Change the logical link to the raw data directory to be
         topdir+'/rawdata' rather than simply '../rawdata'.
         The latter would fail when outputs for some plates were
         in other linked directories, and then '../rawdata' did not
         resolve to anything.
FIND_NMINIMA: Replacement code for FIND_NPEAKS, for solving the chi^2
              minima for redshifts.  This routine will fit a quadratic
              if there are only 3 points, and a gaussian plus a constant
              if there are more than 3 points.
              If there is an error in the fit, return an error code as a
              negative integer in XERR.
GET_MJD_DIR: Make leading zeros significant.  This was necessary to fix
             the bug that '5*' would match 500 but also 050 and 150.
MJD_MATCH: New routine split out of SPPLAN1D.
READSPEC: Minor change to prevent crashing if data for some objects
          does not exist.  Specifically, if structures for some objects
          (e.g., ZANS or TSOBJ) did not exist, this routine could crash.
          Read the synthetic spectrum from the Zbest file if ZNUM is not set.
          This is much faster than regenerating the spectrum.
SPEC_APPEND: Minor change to prevent crashing if data for some objects
             does not exist.  (This routine is used by READSPEC).
SPPLAN1D: Now call MJD_MATCH().
SPREDUCE1D: Change the width in velocity space for fitting the chi^2
            minima in the redshift-finding.  These widths can be broader
            now that we'll be fitting with gaussians rather than quadratic.
            (The quadratic fits were not a good approximation when fitting
            more than a few points.)  Now always use at least 5 points.
            Add another ZWARNING flag: Set the 32L bit if the redshift-error
            warning flag is set to -1, which means that the chi^2 minimum
            was at the edge of the redshift-fitting range.
VDISPFIT: Increase chi^2 computation from [0,475] to [0,600].
ZCOMPUTE: Replace call to FIND_NPEAKS() with FIND_NMINIMA().
ZFIND: Do not modify any errors that are less than zero, since those
       can be used as just warning flags from the fit.
       Increase to search lags (as specified by PMIN,PMAX) according to
       the values of both PWIDTH and WIDTH.
ZFITMAX: Replace call to POLY_FIT with SVDFIT such that this routine
         behaves the same under either IDL 5.3 or 5.4.  It was the
         case that the errors were improperly computed using the re-
         write of POLY_FIT in IDL 5.4.

New template files spEigenGal-52146.fits,spEigenStar-52146.fits
based upon v4_8_1 reductions, though using the same input list of
spectra that we've been using for ages.

In idlutils, added MPFIT routines from Craig Markwardt.  These will
be used for the redshift-finding code (specifically, FIND_NMINIMA).

build_links (in idlutils): Do not build a link for any file if the link
        name already exists.

-------------------------------------------------------------------------------
v4_8_2 (Aug 16, 2001 idlspec2d+idlutils) running on IDL 5.3 - 5.4

Trivial changes for running this version at Fermi.

SPALLREDUCE: SPECFLAT_DIR is not set now, if SPECFLAT product exists and 
          is specified (this proc only used at Fermi).

PLATECOMPARE: New proc for interactive comparison of descrepant redshifts.
PLATELIST: Added /PURGE2D, /PURGE1D options.
PLOTSPEC: Added /NOERASE keyword.  Minor fix to Y plotting range.

RMFILE (in idlutils): Add support for deleting a list of files.
SPLOT (in idlutils): Minor bug fix to avoid plotting the axes twice.
evilinstall (in idlutils): Syntax changes to work with bash on spectro.

-------------------------------------------------------------------------------
v4_8_1 (Aug 9, 2001 idlspec2d+idlutils) running on IDL 5.3 - 5.4
v1_2 of specflat

Cut version for re-running Spectro-2D on all data.

EXTRACT_OBJECT,SMOOTH_SUPERFLAT: Better working smooth_superflat (with a QA
          plot).  Added "Area" to plot anything above 0.01 gives a warning.
FILTER_THRU: Fix failure mode when only a 1-d WAVEIMG is passed.
PLATELIST: Add EXPTIME to output files.
PLOTSPEC: Major re-write to allow flipping through many plots on a plate
          and change plotting parameters.  Or, send plots to PostScript files.
          Usage of ZNUM changed -- see READSPEC for new usage.
          Plot labels in green for legibility in the plot window, and
          include the ZWARNING flag in the label if it is nonzero.
READSPEC: Return successfully even if redshift files not found.
          Change usage of ZNUM such that ZNUM=1 is best fit, ZNUM=2 is 2nd best.
SPCOADD_FRAMES: Set keyword SMEARUSE to T or F.
SPFLATAVE, SPFLATTEN2: Handle edge effects better.  In SPFLATTEN2, set
          any pixels more than 2 pixels from the left/right of the first/last
          fiber equal to zero.  Then, in SPFLATAVE, any edge pixels that are
          zero from all nights are set to unity.
VDISPFIT: Bug fix for objects with negative velocities.
idlspec2d.table: Make an optional dependence upon the "specflat" product.
sprobot.sh: Copy only the compressed ("sdR-*.fit.gz") files from
            sos.apo.nmsu.edu, instead of the raw files from sdsshost.apo.

evilinstall (in idlutils): Minor syntax changes to work with RH7.1 on spectro.
ATV (in idlutils): Handle unsupported CTYPE, CTYPE reversal gracefully;
                   left click on apphot (Imexam) prints coords
SPHEREMATCH (in idlutils): New code to match two lists of RA,DEC.

-------------------------------------------------------------------------------
v4_8_0 (Jul 17, 2001 idlspec2d+idlutils) running on IDL 5.3 - 5.4
v1_1 of specflat

First cut of v4_8 with many major changes.  Not yet tested for prime time.

******MAJOR CHANGE: spFrame output is now normalized with superflat,
                    to correct for small scale features which cannot be removed
                    by standard star correction.
                    HDU 6 now contains the superfit in spFrame
                    Telluric correction has been moved to HDU 7.
          The B-spline break-points in the files blue.bkpts, red.bkpts
          have been changed.

SKYSUBTRACT: Increased rejection limit for 1d fit.  This should be more robust
          anyway, and tighter rejection was masking out real PSF variations
          which led to very big sky residuals in 2d fit.
          Also decreased the number of blue side breakpoints to 1024.

FITVACSET :  keyword "airset" which return air wavelength solution with
          no heliocentric correction (required to properly sample superflat
          shifted to skyline frame)
FIBERFLAT :  keyword superflatset to return normalized superflat fit
DIVIDEFLAT:  removed all traces of fibermask 
EXTRACT_OBJECT, SKYSUBTRACT, SPCALIB: Implement 2D-splining for sky-
          subtraction, now set to do quadratic PSF fit.
          Also, first attempt to put in airmass correction to the sky
          brightness by dividing all the sky vectors by the airmass of
          each fiber, then fitting for the supersky, then multiplying
          back in the airmass terms. 
          New limits to mask in pixelflat 0.8 < flat < 1.2.
                              old values: 0.5 < flat < 1.5
          
EXTRACT_OBJECT: Set the "NEARWHOPPER" mask bits only for fibers within 2
          fibers of a bright fiber, but not the bright fiber itself.
          For the bright fibers, add the bit "WHOPPER" (added to the
          param file spMaskbits.par).
            Changed the rejection thresholds yet again, and also uncommented
          2-D sky subtraction to test.
EXTRACT_OBJECT, SKYSUBTRACT: Exit gracefully in the case of no good sky
          fibers.  In that case, issue an "ABORT" log message, return
          SKYSTRUCT=0 from SKYSUBTRACT, then do not write an spFrame file.
EXTRACT_ROW: Do not correct rejection levels in relative mode if chi^2 < 1.0.
             This means that we can boost the errors to be larger than the
             expected Poisson errors, but not smaller.
FIBERFLAT: Update to call SUPERFLAT() as a function instead of a proc,
           though should not be functionally different yet.
FILTER_THRU: Switch to the newly-measured filtered curves, "sdss_jun2001*.dat".
             Use the Goddard routine LINTERP instead of the IDL built-in
             INTERPOL.  Also, correct the integrations for the pixel size.
FITMEANX: Make robust to no good sky lines for tweaking wavelength solution.
          In that case, the routine LOCATESKYLINES will return SKYSHIFT=0.
FPOLY, FUNC_FIT, TRACESET2PIX, TRACESET2XY, XY2TRACESET:
             Added "poly" as one of the functions for trace sets.
LOCATESKYLINES: Test that the sky line file is successfully read.
MYFLUXCALIB: Fairly major changes: Do a pre-filtering of the spectra that
             go into the PCA-fitting of the flux-calibration vector, and
             mask out the most deviant points.  Run the PCA-fitting with
             more iterations to ensure convergence.  Also, finally comment
             this code.
PCA_SOLVE: Construct the USEMASK from the output mask (OUTMASK) instead of
           from NEWIVAR.  This is equivalent to TOTAL(OUTMASK,2).
           This should make the flux-calibration vectors produced by
           the proc MYFLUXCALIB more robust, since it rejects pixels in
           the solution based upon USEMASK.
PLATELIST: Read MJDLIST keyword from the spPlate files, which will only exist
           with future reductions.
           Include a computation of the airmass in the FITS version of the
           platelist file.
PLATESN: Pass a plot title to PLOTSN.
PLOTSN: For the 2nd page of plots with Synthesized mags. vs. PHOTO fiber mags.,
        make these residual plots.  Also, use plot titles.
QAPLOT_SKYLINE: Plot skyline strength residuals as a function of airmass,
        which in fact is exactly what they are correlated with!
        Issue a warning message if the computed airmasses are out of the
        range [1,3].
REJECT_SCIENCE: New proc to reject science exposures if they are blatantly
                bad (typically, if they are saturated).  We have already been
                doing this for arc + flat exposures.  This proc is called
                by SPREDUCE, and will issue an "ABORT" log message if a
                science frame is rejected.
SDSSPROC: Add VERSLOG, VERSFLAT keywords to specify versions of the
          products SPECLOG, SPECFLAT.
          First search for files "pixflatave-*.fits", and if not found then
          look for "pixflat-*.fits".
SDSSPROC, SPCALIB, SPREDUCE, SPREDUCE2D: No longer pass the name of the pixel
          flat between all these files.  Instead, just let SDSSPROC find the
          correct one in the "specflat" product, in $SPECLOG_DIR/flats.
SMOOTH_HALO: A new version of smooth halo, which should be closer to the truth.
SORTPLUGMAP: Fill in unplugged fibers with arbitrary entries, and assign
       them a FIBERID.  For spectrograph #1, we assign the unplugged fibers
       from the beginning of the plugmap, and for #2 from the end.
       This should result in the unplugged objects being uniquely placed
       on only one of the spectrographs.  This addressed PR #2487.
SPCOADD_FRAMES: Include MJDLIST keyword in spPlate header, which will be
                the list of all MJD's used in an SPCOMBINE.
                Add BUNIT keyword for the flux, inverse variance, and
                dispersion HDU's.
SPFLATAVE: New routine to average together a set (or all!) pixel flats
           in the SPECFLAT directory.
SPFLATGEN: New routine.  Wrapper for SPFLATTEN2 for generating pixel-to-pixel
           flat-fields.
SPFLATTEN2: Major changes! Now call the 2-dimensional B-spline code when
            generating the superflats.  However, there seem to be problems
            with this code for some combinations of NORD and NPOLY.  I have
            set NORD=3, NPOLY=4 which seems to be a combination that works.
            (A PR has been filed against idlutils.)
            Subtract the scattered light image before dividing by the super-
            flat evaluations -- w/out doing this, we had bad residuals where
            the scattered light contribution was large compared to the signal
            (particularly in the UV).
            Also, small changes to how directory names are parsed, and retain
            the header from the file ALLFLATS[0] for the output file.
SUPERFLAT: Pass X2, NORD and NPOLY keywords to support fitting 2-dimensional
           B-splines in the call to BSPLINE_ITERFIT().  At the moment,
           this will only be implemented for the proc SPFLATTEN2, not for
           FIBERFLAT.  (So this shouldn't effect the spectro reductions
           except for updated pixel flats.)
           Also, make this a function instead of a proc.
TELLURIC_CORR: Fixed horrible bug in using fibermask to reject bad fibers
               (fixes PR #2162).  Also, when fitting the local continuum
               around a single telluric band for a single star with a
               polynomial, do the fit with weighted points and iterated
               rejections using DJS_REJECT().
THROUGHPUT_CALIB: New proc for assessing total system throughput using
                  the intermediate files "spFluxcalib*.fits".
TRACE320CRUDE: Added call to DJS_MASKINTERP() in the beginning to prevent
               hot columns from throwing the initial trace (which does
               not use the errors at all).
zplot: Quick-and-dirty script for finding and plotting a spectrum (at Princeton)
       w/out setting up any path variables or SDSS products.

f8v.abs: Increase flux-calibrating mask around H-alpha by 50%, now
         masking +/- 1500 km/s (+/- 32.8 Ang).
opBC-51813.par: One extra bad column [370,1800:2047] on r2.
       There are a few extra additions to match the new pixflatave-00000 files.
       Instead of flagging all of the "pits", these are not included, but
       can be rejected using minflat/maxflat = 0.8/1.2

BSPLINE_ACTION, INTRV (in idlutils): Bug fixes for 2-D spline fitting.
     Include 'poly1' function in BSPLINE_ACTION(), and set the function
     properly in BSPLINE_ITERFIT.
BSPLINE_FIT, BSPLINE_ITERFIT (in idlutils):
     Remove MASK keyword, since it is too confusing with INMASK, OUTMASK
     already used in BSPLINE_ITERFIT().  It didn't look like it was
     actually used anyway!
DJS_REJECT (in idlutils): Add the GROUPDIM keyword, and allow GROUPDIM,
          MAXREJ and GROUPSIZE to be vectors for several limits in the
          rejection algorithm.  These were some major changes, and hopefully
          are completely backwards-compatable.
SPLOT (in idlutils): Changed interactive gaussfit (g) so amplitude is correct.
YANNY_READ (in idlutils): Try to make backwards-compatable with IDL 5.2
          by replacing calls to STRSPLIT() with calls to STR_SEP.
build_links (in idlutils): New script for building links between directories.
evilinstall (in idlutils): Add another option for location of sdssfue
          scripts (for the installation on sos.apo), and also set the
          CVS locations to the default at Fermi if not set up with
          "setup sdsscvs".

-------------------------------------------------------------------------------
v4_7_6 (Jun 9, 2001 idlspec2d only)

data_rysnc.sh: Bug fixes in SOS copy, and adaptation to sos.apo.nmsu.edu
               (i.e. ps -elf does not work, and scp1 does not exist).

-------------------------------------------------------------------------------
v4_7_5 (Jun 8, 2001 idlspec2d only)

data_rsync.sh: SOS should now attempt to archive data with gzip and move
               offsite in the morning.
killdata.sh, mailhtml.sh, sos.sh, startapo.sh, APOREDUCE:
               Adapted to work on sos.apo.nmsu.edu, and fixed file transfer
               bugs.  For APOREDUCE, changed spawn of "scp1" to "scp", since
               the former did not exist on the new machine sos.apo.

sprobot_start: Remove "sprobotcopy" from the cron jobs, since copying
               reduced data to Fermi always fails.
               Set SPECLOG_DIR=$ASTROLOG_DIR for the Spectro-Robot.

-------------------------------------------------------------------------------
v4_7_4 (May 10, 2001 idlspec2d+idlutils)

COPY_STRUCT, COPY_STRUCT_INX (in idlutils):
          These routines didn't work properly for structures with more
          than 32768 elements, because of using only 2-byte integers.
          This resulted in READSPEC not working properly for large lists,
          and other dependent routines such as ZPLOT (where I noticed it!).
READSPEC: Bug fix when reading one range of fiber numbers for a FITS
          binary table, i.e. "READSPEC, 301, [1,2,3], ZANS=ZANS" was not
          returning the correct values.
ZPLOT: Include MJD in call to READSPEC.

spPlateList.par: Enlarge list of EDR plates to include multiple pluggings,
       and other plates that should have been in the list according to van
       den Berk's mail to sdss-spectro/665 on 2 May 2001.  The list now
       includes 136 plates, many of which are repeat observations.

Spectro-Robot scripts:
       Let the scripts "sprobot2d.sh" and "sprobot1d.sh" test whether they
       are already running, and quit if they are.
       Update the syntax to "ps" commands as per RHL's suggestions.
       From sprobot.sh: Batch process 2D first, wait for it to complete,
       then batch process 1D in the background.

-------------------------------------------------------------------------------
v4_7_3 (Apr 30, 2001 idlspec2d+idlutils)

PLATESN: Typo introduced on April 13th that crashes SPCOMBINE -- fixed!
SDREPORTMAKE: New proc for generating sdReport files from raw idR files.

In idlutils:
YANNY_READ: Add optional /ANONYMOUS flag to avoid conflicts in structure
            types, in the event that named structures actually change
            between calls (will be used by SDREPORTMAKE).
            Split lines with semi-colons, for when reading early sdReport
            files with SDREPORTMAKE; however, this may introduce bugs
            elsewhere because it was not done totally generally.

In the Spectro-Robot bash scripts, change the top-level directory for
the plug-map files from $SPECLOG_DIR to $ASTROLOG_DIR.  Use the $SPECLOG_DIR
only for re-running with cut versions of everything, including the "speclog"
product.

-------------------------------------------------------------------------------
v4_7_2 (Apr 27, 2001 idlspec2d only)

PLATELIST: Use the "spPlateList.par" file to determine which data are public.
           Add a PUB column to denote if a plate is in a public data release.
PLATEMERGE: Add the /PUBLIC option to trim only to public data.

More updates to "opHdrFix.par" file.
Makefile in /bin did not copy all executables when installing; now it does.
Update the batch files to use the wire machines as a default.
Update spectro home page to reflect v4_7 reductions.

-------------------------------------------------------------------------------
v4_7_1 (Apr 9, 2001 idlspec2d+idlutils)

FILTER_THRU: Add new Doi filter curves (CCD+atmosphere+telescope), and
             add /TOAIR flag to convert from vacuum to air wavelengths.
             (But not yet called by 2D or 1D).
PCA_SOLVE, COMPUTECHI2: Make robust to one or all of the template spectra
              (e.g., the STARFLUX vectors) being identically zero.
              The routine PCA_SOLVE could crash w/out special-casing this
              due to an apparent bug in the built-in routine PCOMP().
SPCOMBINE, SPCOADD_FRAMES: Optionally allow spFrame files to be g-zipped.
READSPEC, SPREDUCE1D: Allow spPlate, spZ files to be g-zipped.
READSPEC: Major changes to speed up the code when reading a sparse number
          of fibers per plate.  It used to read all the fibers between the
          smallest and largest fiber number.  Now it divides up the requested
          fibers into contiguous chunks, and reads in only those chunks.
          (The plate file is still only opened once, and the header is only
          read once.)

Add new mask bit: NEARWHOPPER.  This effects the following routines:
              EXTRACT_OBJECT, FLUXCORR_NEW, MYFLUXCALIB, TELLURIC_CORR.
              These fibers are also implicitly ignored by sky-subtraction
              because the sky-fiber selection implicitly assumes all fiber-
              mask bits are fatal (in EXTRACT_OBJECT).

Son-of-Spectro changes:
New executable, "sos_redo" to re-run SOS on failed reductions.
APO_APPENDLOG: Now overwrite entries in the file "logfile-$MJD.fits" if an
              exposure is re-reduced (e.g., with "sos_redo").
APO_LOG2HTML: Placed a lower limit of (S/N)^2 > 2.0 to count towards total
              in each camera
QUICKEXTRACT: Change message about post-cabibs from "REQUIRED" to merely
              "recommended."
              Slightly loosened constraints on match_trace to +/- 0.15 pixels.
QUICKTRACE: Tweak test for putative Argon lines in flats to be a less
            sensitive trigger.
REMOVE2REDO: (New proc) Checks for missing entries in logfile*fits and
            removes corresponding raw data; called by script "sos_redo".
The routine FIND_WHOPPING is moved out of EXTRACT_OBJECT so that it can
            be called by QUICKEXTRACT.
Changed SOS signal-to-noise warning to a yellow warning below S/N=15/pix,
            and S/N=13/pix.
More entries in "opHdrFix.par" to fix all the incorrect plugmap files
            known to date.  However, we still need to get the correct
            files copied into the /astrolog directories.

-------------------------------------------------------------------------------
v4_7_0 (Mar 16, 2001 idlspec2d+idlutils)

FLUXCORR_NEW: Replace deviant fluxcorr coefficients with the median
              Attempt to mask large positive deviations in inverse variance
              (PR #2040) 
SPCOMBINE:    combinedir is now a keyword for spcoadd_frames.
              SPFLUX and SPCOADD_FRAMES utilize directory keywords as well.
              Start by zeroing-out the 4 mask bits set by combining step.
FIBERFLAT:     Simple check to exclude extrema  (PR #2123)
COMBINE1FIBER: Replace the lines which errantly set NODATA with a check for the
               extrema wavelengths which have no signal. (PR #1939)
SPPLANCOMB, 
SPALLCOMBINE:  Fixed Bug to combine a specific MJD

BSPLINE_ITERFIT (in idlutils): Modified to avoid crashing SPREDUCE1D.
   Two changes: (1) Return a valid solution even in the case where the variance
   of the y-vector is zero.  (2) In the case where there are too few points to
   fit, still return a valid solution of all zeros.
FINDSPEC: New routine for finding SDSS spectra that match a given RA, DEC.
MULTISYNTHSPEC: New routine that is sometimes faster than SYNTHSPEC, but
           I would not recommend using this yet.
MYFLUXCALIB: Make robust to degenerate case of only 1 input spectro-photo std.
PLATELIST: Lower (S/N)^2 cutoff to 13 for all G,I bands (from 15 previously).
           If ZWARNING flag exists in 1D outputs, use that to determine
           number of UNKNOWN or SKY identifications.
PLOTSPEC: Add ZNUM option (also new to READSPEC).
READSPEC: Add option to generate the synthetic spectra.
          Add ZNUM option to get fits other than the best fit.
REDMONSTER: New routine for looking for Red Monster (large regions of
            bad sky residuals, which, for example happens when the hand-paddle
            light is on at the telescope).  Flag these pixels with the
            REDMONSTER mask bit.  This routine replaces MONSTER.
SPREDUCE1D: Search for stars at velocities to +/- 1200 km/s (was 600 km/s).
            No longer identify objects as UNKNOWN, but rather set bits
              in a ZWARNING flag.
            Add outputs ZWARNING, SN_MEDIAN, FRACNSIGMA,
              COUNTS_SPECTRO, COUNTS_SYNTH, COUNTS_SKY (not used yet),
              VDISP, VDISP_ERR, ANYANDMASK, ANYORMASK.
            Compute velocity dispersions using real-space method (VDISPFIT).
            Slightly increase width for re-fitting galaxy redshifts from
              PWIDTH=5 to 7.  This may fix PR #1938.
            Speed up computation of FRACNSIGMA by calling FILTER_THRU()
              for the whole plate at once.
            Output SYNFLUX as a 2nd HDU in the spZbest*.fits file.
SYNTHSPEC: Calling sequence now allows for returning an array of spectra.
TELLURIC_CORR: If a telluric star is deemded bad, then reject all of
            its FITFLUX pixels from the global fit.  Previously, we were
            only rejecting the pixels INDT, but still allowing bad continuum
            pixels into the fit.  This fixes PR #2028.
YANNY_PAR (in idlutils): If several lines have the same keyword name,
            then return all of those values as an array.  This makes this
            routine backwards-compatable with Yanny files written previously
            with SPPLAN2D.
ZFIND: Get rid of SIGMA2,SIGMA2_ERR and add VDISP,VDISP_ERR.

Add new mask bits: BADSKYCHI, REDMONSTER, SMEARIMAGE, SMEARHIGHSN, SMEARMEDSN.

New installation script "evilinstall" in the idlutils product.

Add a line to the cron tables from "sos_start" and "sprobot_start" to
keep the disk auto-mount points alive at Princeton (or anywhere using an
amd daemon).

-------------------------------------------------------------------------------
v4_6_2 (Feb 14, 2001)

For the Fermi calling script SPALLREDUCE, add an NCOMBINE keyword
to limit the number of exposures combined.  Default to a maximum of 7.

-------------------------------------------------------------------------------
v4_6_1 (Feb 14, 2001)

SPCOMBINE: Reverting to adderr=0.03 to prevent rejections in high S/N regions
SKYSUBTRACT: The "fix" in the previous version didn't properly check the
             bad mask bits, and in fact could make things worse.  Now fixed.

-------------------------------------------------------------------------------
v4_6_0 (Feb 9, 2001)

EXTRACT_OBJECT: Reverted to Gaussian Profile, more robust flat field 
                 interpolation, still 3% are fluctuations when 
                 NEARBADPIXEL is set.
FIBERFLAT: Fiber is flagged BADFLAT is more than 30% of pixels are masked.
FLATINTERP: Remove call to this code.
SPCALIB: Back to original flat field rejection levels matches object extraction.
SKYSUBTRACT: Check for NEARBADPIXEL and LOWFLAT bit as well in pixelmask.

Add BADFLUXFACTOR mask bit when applying flux-calibration and flux-correction
vectors.

Fixed DJS_BATCH to work properly on remote but cross-mounted CPU's.

Plan files (spPlancomb*.par) written by SPPLAN1D now puts all the "planfile2d"
entries on the same line to be consistent with how YANNY_PAR() works now.

Fix the spike in memory usage at the end of SPCOMBINE.

Major changes to PLATELIST routine to return more info, and make a FITS
binary table.

-------------------------------------------------------------------------------
v4_5_0 (Jan 31, 2001)

Edits to raw frame headers now possible with SPHDRFIX procedure, which
reads the list of changes from opHdrFix.par file.  In particular, this
allows us to edit wrong headers in some of the earliest data.

The F-star flux-calibration vectors are generated with a PCA analysis
that now allows several rejection iterations.

More iterations added to the arc-line centroiding in FITARCIMAGE
(addresses PR #874).

Son-of-Spectro now tests for the Red Monster (light at 6400-6550 Ang in
science frames), and tests for argon lines in the flat-fields.  The Red
Monster is presumably from the handpaddle being left plugged in.

SPREDUCE1D: If an object is fit by a negative STAR or negative QSO, then
            re-classify it as UNKNOWN.

-------------------------------------------------------------------------------
v4_4_0 (Jan 23, 2001)

Remove any telluric-correction beyond 8250 Ang, since we don't believe
any of it there.  In fact, it looks like we were multiplying-in features
that are F-star absorption lines at 8540 and 8660 Ang.  But what about
the broad feature at 8665 Ang -- is that a telluric-band, or an intrinsic
F-star feature??

Keyword CARTID added to headers to track cartridge ID's.

Spectro robot scripts included in /bin directory (sprobot_start, etc.)

For Son-of-Spectro, the WARNING and ABORT messages are now saved in HDU #5
of the FITS log file, rather than as an element of the other HDU's.

For Son-of-Spectro, now only copies astrolog directory of existing
/data/spectro/$MJD data directory, since from now on the astrolog directory
will never be purged.

-------------------------------------------------------------------------------
v4_3_1 (Dec 10, 2000)

This version of "idlspec2d" has the following enhancements for
Son-of-Spectro (SOS):

(1) The hard-wired user/machine/version dependencies have been removed.
    SOS can now be run by any user on any machine, which we may want to
    do to avoid conflicts with the fiber-mapper.  Though for now, this
    will continue to be run from "observer@plate-mapper".
(2) Starting+stopping SOS is now done with the commands
       sos_start
       sos_status
       sos_stop
    which will start-up whichever version of the code has been either
    declared or set up.  Backing out of versions is now straight-forward.
(3) The code can now be managed remotely.  For example, from "sdsshost"
    you can type:
       setup idlspec2d
       sos_status observer@plate-mapper
    to check the status of SOS.
(4) SOS delays execution when the fiber-mapper is being run.
(5) More logging information is kept.
(6) Identified and removed Y2022 bugs which would have stopped SOS from
    working at MJD=60000.  It should now work until the year 2132.
(6) Documentation is now complete, and updated to reflect all above changes.
    The relevant documentation is also in the "sdssProcedures" product.

-------------------------------------------------------------------------------
v4_3_0 (Dec 6, 2000)

The changes are primarily to the Son-of-Spectro (SoS) code, specifically:

(1) The FITS log files have been re-structured to significantly speed
    up reading these files.  This was the bottleneck that slowed SoS
    down towards the end of a night, since each instance of reading these
    files locked out other processes.  Our hope is that now SoS will
    keep up during the night.
(2) Bias and dark exposures are now analyzed, and the 98th percentile
    of all values in these images are reported to SoS.  For example,
    if 98% of the pixels in a bias are below 8 ADU, then PERCENTILE98 = 8.
(3) The operational limits file has been edited so that SoS values
    that appear in red should definitely be considered very bad.
    For example, if the number of arc lines found (NLAMPS) is red, then
    that arc exposure should be considered bad and another should be
    taken until a good number are found.
      In practice, we expect it to be rare that anything falls out of spec.

-------------------------------------------------------------------------------
v4_2_0 (Nov 28, 2000?)

1)  Skip low S/N smear images in flux correction (previously aborted)

2)  Added bad columns to opBC.par

3)  Fixed bug in sdssproc when dealing with shifted rows between
    MJD 51578 AND 51580 inclusive.

4)  Changed structure of spMerge2d to have [flux,err] as image
    in HDU 0, and [andmask, ormask, dispersion] as binary table in HDU 1.

5)  Added headers cards to HDU's 1-5 in spPlate*fits to include wavelength
    information.

6)  Fixed bug to work on sdR*gz files.


-------------------------------------------------------------------------------
v4_1_0 (Oct 20, 2000?)

The following lists the highlights/lowlights
of the new 2d version:

Here is a catalog of the raw 2d output:

    spFrame-cc-xxxxxxxx.fits       Object Frame extraction

        HDU0 :  "Flattened" counts per pixel   Float 2048x320
        HDU1 :  Inverse variance of HDU0       Float 2048x320
        HDU2 :  Pixelmask (see below)          Long  2048x320
        HDU3 :  Wavelength coefficients        Structure
        HDU4 :  Dispersion coefficients        Structure
        HDU5 :  plPlugMapP for 320 fibers      Structure
        HDU6 :  Telluric correction image      Float 2048x320  (only for red)

    spSky-cc-xxxxxxxx.fits    2048x320  Subtracted sky image
    spFlat-cc-xxxxxxxx.fits   2048x320  flat field vectors
    spArc-cc-xxxxxxxx.fits    2048x320  Arc spectra extractions +
                                           HDU1: inverse variance
    spDiag2d-pppp-mmmmm.ps
    spDiag2d-pppp-mmmmm.log

Legend:

xxxxxxxx  Frame number
pppp      Plate number
mmmmm     MJD
cc        camera
s         spectrograph

Just before combining 2 or more exposures into fully merged spectra
we perform two flux calibration steps.   The outputs are:

    spFluxcalib-xxxxxxxx-s.fits   Bspline structure to convert 
                                  flattened counts to 10^-17 ergs/s/cm^2/A

    spFluxcorr-xxxxxxxx-s.fits    Polynomial coefficients to correct 
                                  science frames to smear frame

The final coaddition uses spFrame, spFluxcalib, and spFluxcorr to create

    spPlate-pppp-mmmmm.fits    Fully calibrated final 2d output

        HDU0 :  Fluxed log-linear spectra   Float npix x 640  where npix ~3900
                 units of 10^(-17) ergs/s/cm^2/A

        HDU1 :  Inverse variance of HDU0
        HDU2 :  Pixelmask (Intersection  aka AND mask)  LONG npix x 640
        HDU3 :  Pixelmask (Union  aka OR mask)          LONG npix x 640
        HDU4 :  Dispersion Image (sigma of arc lines)
                  in units of 1.0e-4 log10 lambda
        HDU5 :  plPlugMapP                              STRUCTURE

After the final coaddition, the data will be restructured into 
individual files, one for each fiber:

    spMerge2d-pppp-mmmmm-fff.fits   (fff is fiber number 1 through 640)
        
        HDU0 :  Flux and err      Float npix x 2
        HDU1 :  Pixelmask AND,OR  LONG  npix x 2
        HDU2 :  Dipsersion image  Float npix x 1


!!!!!Notice:  Multiple MJDs with the same plugging will be combined!!!!!
             into single outputs, but will be labeled with the 
                 highest MJD of the group.
  
             Bad data which should not be combined
             with subsequent data should be deleted before the subsequent
             data is run through 2d.

New features of v4_1_0:

  Major New Features:

    1) Spectrophotometry:
       
      a)  Flux calibrate with all available SPECTROPHOTO_STD and
          REDDEN_STD stars.  Use PCA to derive first and second
          eigenspectra.  Compare directly with SDSS Fundamentals to
          calibrate each smear exposure.  
      
      b)  Flux correct each science frame with throughput and color
          terms to match spectrophoto solution of smear image for
          each fiber.  Use SPECTROPHOTO_STD solution to low S/N fibers.

    2) Correct for Near Infrared Scattering (see msg from jeg) and
       possible optical scattering.  The scattered light background
       is estimated from a model profile of the full 2048x2048 image.

    3) New maskbits:
       
        Each individual frame extracted by 2d has the following maskbits
        possibly set for each pixel: (found in idlspec2d/etc/spMaskbits.par)

      # The following mask bits are for the fiber, set in FIBERMASK_BITS()
maskbits  0 NOPLUG          # Fiber not listed in plugmap file
maskbits  1 BADTRACE        # Bad trace from routine TRACE320CRUDE
maskbits  2 BADFLAT         # Low counts in fiberflat
maskbits  3 BADARC          # Bad arc solution
maskbits  4 MANYBADCOLUMNS  # >10% pixels are bad columns
maskbits  5 MANYREJECTED    # >10% pixels are rejected in extraction
maskbits  6 LARGESHIFT      # Large spatial shift between flat and object pos'n
maskbits  7 BADSKYFIBER     # Sky Fiber shows extreme residuals

# The following mask bits are for a pixel, set in PIXELMASK_BITS()
maskbits 16 NEARBADPIXEL    # Bad pixel within 3 pixels of trace
maskbits 17 LOWFLAT         # Flat field less than 0.5
maskbits 18 FULLREJECT      # Pixel fully rejected in extraction (INVVAR=0)
maskbits 19 PARTIALREJECT   # Some pixels rejected in extraction
maskbits 20 SCATTEREDLIGHT  # Scattered light significant
maskbits 21 CROSSTALK       # Cross-talk significant
maskbits 22 NOSKY           # Sky level unknown at this wavelength (INVVAR=0)
maskbits 23 BRIGHTSKY       # Sky level > flux + 10*(flux-error)
maskbits 24 NODATA          # No data available in combine B-spline (INVVAR=0)
maskbits 25 COMBINEREJ      # Rejected in combine B-spline

        Maskbits 0 through 7 apply to the full set of 2048 pixels on 
        blue or red spectra.

        The combined spectra found in spPlate*fits or spMerge2d*fits
        have two masks:  
          AND mask: the bit is set if all overlapping pixels is set.
          OR  mask:         "         any overlapping pixel bit is set.

Minor changes: 
     
    1) Lower limit to variance in raw image, 
       equivalent to S/N < 100 per pixel.

    2) New optimal extraction profile: 0.5 * exp(-x^2) + 0.5*exp(-|x|^3)
       (proftype 3)

    3) Restricted wavelength range in telluric correction
    
    4) Tighter rejection limits, more stringent cosmic rejection
       limits: +- 4 sigma

    5) Sign has been corrected in heliocentric velocity

    6) The header has the following changes:

         CALID*  has been deleted
         UNSIGNED has been deleted
         
         FRAMESN2    S/N^2 for each frame, does not apply to merged
                          spectra
         EXPID       can accomodate more than 10 exposures
         PIXFLAT:    2d pixel flat used
         OPBC:       bad pixel file applied
         OPECALIB:   opEcalib file applied
         OPCONFIG:   opConfig file applied

         SPEC1_G, SPEC1_R, SPEC1_I
         SPEC2_G, SPEC2_R, SPEC2_I :  Fiducial S/N across spectrographs
            
         MAG_G, MAG_R, MAG_I : Synthetic magnitude after
                               spectrophotometry

      
     7) Bspline package no longer requires slatec library

     8) Sky fibers with significant extra flux are rejected

     9) Number of bad fibers with given bits set are tabulated at end
   
    10) pipeline can run and use .fit.gz  gzipped raw data files,
        saving about 40% of space required by raw spectro data
     
    11) Spectral Resolution is output in the final merged spectra.

    12) Use a better algorithm to tweak flat field trace to match object
        trace.

    13) Fixes in to account for electronics problem in August

-------------------------------------------------------------------------------
v3c (May 12, 2000?)

It still requires idlutils v3b to run.
It is tagged on the branch, v3branch, and includes the following
improvements to the 2d pipeline:

- Auto-generation of S/N plot at conclusion of spectra merging.
- Increased number of supersky breakpoints to achieve better sky subtraction
- Added entries to opBC.par file, this will remove most of the remaining
  glitches.
- Added a new routine, "spmulti", which can combine multiple MJDs
  with the same plugmap file
- Heliocentric correction is now done on an exposure by exposure basis in 2d.
- Removed header cards which are no longer pertinent, and added some
  extras requested by Andy.
    Ones to note are NGOOD (number of good pixels in final spectrum)
    SN_G, SN_R, SN_I  (3 measures of S/N)
- Dispersion and spatial widths are output as a function of fiber
  fiber number & pixel (in spArcInfo and spFlatInfo respectively)


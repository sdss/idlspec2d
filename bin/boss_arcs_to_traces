#!/usr/bin/env python3
from boss_drp.sos.arc2tracelogger import Logger
from boss_drp.prep.boss_arcs_to_traces import boss_arcs_to_traces
from boss_drp.utils.hash import create_hash

from pyvista import boss

import argparse
import matplotlib
import os
import os.path as ptt
import sys
import time

if __name__ == "__main__":
    descr = "Routine to transfer trace locations from an initial arc/flat pair given subsequent arc frames only"
    parser = argparse.ArgumentParser(description=descr, usage="boss_arcs_to_traces MJD")
    parser.add_argument("--mjd", type=int, help="MJD to process",required=True)
    parser.add_argument("--outdir", type=str, help="output directory")
    parser.add_argument("--obs", type=str, help="observatory (lco|apo)",default='lco')
    parser.add_argument("--vers", type=str, help="BOSS_SPECTRO_REDUX version",default='master')
    parser.add_argument("--threads", type=int, help="number of threads",default=8)
    parser.add_argument("--cams", type=str, help="Supply the camera for operation with SOS files", default=None)
    parser.add_argument("--fitsname", type=str, help="Supply the FitsName for SOS error reporting", default=None)
    parser.add_argument("--sosdir", type=str, help="Base SOS output directory", default=None)
    parser.add_argument("--clobber", action="store_true", required=False, help="clobber?")
    parser.add_argument('--no_hash', default=False, action='store_true', help='Skip updating the file hash')
    args = parser.parse_args()
    
    
    
    if args.vers.lower() == 'sos':
        logfile = ptt.splitext(ptt.splitext(ptt.basename(args.fitsname))[0])[0]+'.log'
        logfile = logfile.replace('sdR', 'spTraceTab')
        logfile = ptt.join(f'{args.sosdir}',f'{args.mjd}','trace',f'{args.mjd}',logfile)
        log = Logger(logfile)
        log.start(cmd = sys.argv)
        cmd = sys.argv
        cmd[0] = ptt.basename(cmd[0])
        
        boss_arcs_to_traces(mjd = args.mjd, outdir = args.outdir, obs = args.obs, vers = args.vers,
                            threads = args.threads, cams = args.cams, fitsname = args.fitsname,
                            sosdir = args.sosdir, clobber = args.clobber)

        log.stop()
        if not args.no_hash:
            test = create_hash(ptt.join(args.sosdir,str(args.mjd)))
            if test:
                print("\nsha1sum is locked")
        sys.exit(0)

    else:
        boss_arcs_to_traces(mjd = args.mjd, outdir = args.outdir, obs = args.obs, vers = args.vers,
                            threads = args.threads, cams = args.cams, fitsname = args.fitsname,
                            sosdir = args.sosdir, clobber = args.clobber)


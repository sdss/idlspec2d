#!/usr/bin/env python3
from boss_drp.run.uubatchpbs import uubatchpbs
from boss_drp.utils import load_env
from boss_drp.Config import config, update_key
from boss_drp.utils.argparse_help import MultiBoolAction
import argparse
from os import getenv
import os.path as ptt
import sys


if __name__ == '__main__' :
    """
    Batch process Spectro-2D and Spectro-1D reductions based upon already-built plan files
    """
    parser = argparse.ArgumentParser(
            prog=ptt.basename(sys.argv[0]),
            description='Build idlspec2d redux and submit to the cluster queue. Without access to the SDSS Slurm package, it prints the commands for manual execution')


    shortgroup = parser.add_argument_group('Short cuts')
    shortgroup.add_argument('--sdssv', action='store_true', help='--mwm --no_merge_spall --no_reject --merge3d')
    shortgroup.add_argument('--apo', action = 'append_const', help='Run apo', const='apo', dest='obs')
    shortgroup.add_argument('--lco', action = 'append_const', help='Run lco', const='lco', dest='obs')
    shortgroup.add_argument('--bay15', action='store_const',dest='map3d', const='bayestar15', help='Set map3d to bayestar15 model')
#    shortgroup.add_argument('--eden23', action='store_const', dest='map3d', const='edenhofer2023', help='Set map3d to edenhofer2023 model')
    shortgroup.add_argument('--merge3d', action='store_const',dest='map3d', const='merge3d', help='Set map3d to best 3d model')

    rungroup = parser.add_argument_group('idlspec2d Run options')
    rungroup.add_argument('--obs', help='Observatory {apo,lco}', nargs='*', choices=['apo','lco'], type=str.lower)
    rungroup.add_argument('--topdir', type=str, help='Optional override value for the environment variable $BOSS_SPECTRO_REDUX',
                          default = getenv('BOSS_SPECTRO_REDUX'), dest = 'BOSS_SPECTRO_REDUX')
    rungroup.add_argument('--run1d', type=str, help='Optional override value for the enviro variable $RUN1D',
                           default=getenv('RUN2D'), dest='RUN2D')
    rungroup.add_argument('--run2d', type=str, help='Optional override value for the enviro variable $RUN2D', 
                          default=getenv('RUN1D'), dest='RUN1D')
    rungroup.add_argument('--idlutils_1d', type=str, help='idlutils override version of spec1d', default=None)
    rungroup.add_argument('--no_reject', action='store_true', help='Deactivate Rejection in Coadd')
    rungroup.add_argument('--MWM_fluxer','--mwm', action='store_true', help='')
    rungroup.add_argument('--map3d',type=str.lower,default=None, dest='map3d',
                            help='Name of 3d dustmap to use with MWM_fluxer (default=None)',
                            choices = ['bayestar15','bay15','merge3d']) #['bayestar15','bay15','edenhofer2023','eden23','merge3d'])
    rungroup.add_argument('--noxcsao', action='store_false', help='Skip pyXCSAO',dest='run_XCSAO',default=True)
    rungroup.add_argument('--nodist', action='store_false',dest='nodist', help=argparse.SUPPRESS)
    rungroup.add_argument('--dist',   action='store_true', dest='nodist',
                            help='unsets --nodist and reactivates the flux distortion corrections')

    rungroup.add_argument('--skip_specprimary', action='store_const',const='skip', help='Skip Calculation of Specprimary', default=None)
    rungroup.add_argument('--update_specprimary', action='store_const',const='update', help='Only update new Specprimary', 
                          default=None, dest='skip_specprimary')

    rungroup.add_argument('--onestep_coadd', action='store_true', help='Use legacy one step version of coadd')
    rungroup.add_argument('--fibermap_clobber', action='store_true', help='Clobber spfibermap fits file', 
                           dest='clobber_fibermap')
    rungroup.add_argument('--saveraw', action='store_true', help='Save sdssproc outputs')
    rungroup.add_argument('--debug', action='store_true', help='Save extraction debug files')
    rungroup.add_argument('--no_db', action='store_true', help='skip Database operations')
    rungroup.add_argument('--fast_no_db',  required=False,
                          help='When using --no_db, streamlines process and only gets parallax from MOS target files')
    rungroup.add_argument('--release', required=False,
                          help='sdss_access data release (defaults to sdsswork), required if you do not have proprietary access, '+
                               'otherwise see https://sdss-access.readthedocs.io/en/latest/auth.html#auth', default=None)
    rungroup.add_argument('--v_targ',dest='V_TARG', default=None, help='SDSS-V MOS Targeting Product Version  (for no Database access use)')
    rungroup.add_argument('--a2t', help='Force Use of Arc2Trace', action='store_true',dest='force_arc2trace')
    rungroup.add_argument('--clobber', action='store_true', help='Clobber redux', dest='clobber_pipe')



    stepgroup = parser.add_argument_group('Pipeline Step options')
    stepgroup.add_argument('--no_healpix','--nohp', action='store_false', help='Turn off copy to healpix', 
                           dest='run_healpix', default=True)
    # stepgroup.add_argument('--no_merge_spall', action='store_false', help='Skip building full SpAll File', 
    #                        dest = 'run_Summarymerge', default=True)
    stepgroup.add_argument('--skip2d', action = MultiBoolAction, dests=['run_fibermap','run_reduce2d'],
                          nargs = 0, const= False, default=True, help = 'Skip spreduce2d')
                          
    stepgroup.add_argument('--only1d', action = MultiBoolAction, 
                           dests=['run_fibermap','run_reduce2d','run_combine','run_fieldlist','run_fieldmerge',
                                  'run_specFiles','run_spcalib','run_healpix','run_Summarymerge'],
                          nargs = 0, const= False, default=True, dest=argparse.SUPPRESS,
                          help = 'run spec1d step only (eg. spreduce1d_empca, XCSAO)')       

    fieldgroup = parser.add_argument_group('Select Fields')
    fieldgroup.add_argument('--field', '-f', nargs='*', help='Plate/Field numbers to reduce default="*"', type=str)
    fieldgroup.add_argument('--fieldstart', help='Starting Field/Plate number', default=None, type=str)
    fieldgroup.add_argument('--fieldend', help='End Field/Plate number', default=None, type=str)

    mjdgroup = parser.add_argument_group('Select MJDs')
    mjdgroup.add_argument('--mjd', '-m', nargs='*', help='MJD dates to reduce; default="*"', type=str)
    mjdgroup.add_argument('--mjdstart', help='Starting MJD', default=None, type=str)
    mjdgroup.add_argument('--mjdend', help='Ending MJD', default=None, type=str)

    configgrp = parser.add_argument_group('Configurations')
    configgrp.add_argument('--pipe_config', '--pc', help='Queue Config name', default='boss_drp', dest='config')
    configgrp.add_argument('--pipe_config_file', '--pcf', help='Queue Config File Path', default=None, dest='config_file')
    configgrp.add_argument('--queue_config', '--qc', help='Queue Config name', default='tagged_daily')
    configgrp.add_argument('--queue_config_file', '--qcf', help='Queue Config File Path', default=None)

    queuegroup = parser.add_argument_group('Queue Options')
    queuegroup.add_argument('--no_write', action='store_true', help='skip writing and submitting job')
    queuegroup.add_argument('--mem_per_cpu', help='Memory allocated per CPU', type=str)
    queuegroup.add_argument('--walltime', help='Wall time in hours', type=str)
    queuegroup.add_argument('--nodes', default=None, help='Number of Nodes', type=int)
    queuegroup.add_argument('--ppn', help='Number of processors per node', type=int)
    queuegroup.add_argument('--nosubmit', action='store_true', help='Build, but not submit redux files')
    queuegroup.add_argument('--nbundle', help='Number of jobs to bundle', type=int, default= None)
    
    customgroup = parser.add_argument_group('Custom Coadd Options')
    customgroup.add_argument('--epoch', action='store_true', help = 'Epoch Coadds')
    customgroup.add_argument('--custom', help = 'Name of custom Coadd Schema', type=str, dest= 'custom_name')
    customgroup.add_argument('--allsky', action='store_true', help = 'All Sky Coadds')
    customgroup.add_argument('--single_mjd', action='store_true', 
                             help = 'Run Each Custom MJD coadd+1dpost as seperate job', dest = 'custom_single_mjd')
    customgroup.add_argument('--coadd_only', action=MultiBoolAction, help= 'Run spspec_target_merge only', 
                             dests=['run_fibermap','run_reduce2d','run_analyze','run_fieldlist','run_spcalib',
                                    'run_fieldmerge','run_specFiles','run_healpix','run_Summarymerge'], 
                             dest = argparse.SUPPRESS, nargs = 0, const = False, default = True)
    customgroup.add_argument('--1dpost', action=MultiBoolAction, help= 'Run 1d analysis and post processing only', 
                              dests=['run_fibermap','run_reduce2d','run_combine','run_fieldlist','run_spcalib',
                                     'run_healpix','run_Summarymerge'], 
                              nargs = 0, const = False, default = True, dest=argparse.SUPPRESS)

    emailgroup = parser.add_argument_group('Email outputs')
    emailgroup.add_argument('--email', action='store_true', help='Email log using $DAILY_DIR/etc/emails', dest='sendemail')
    emailgroup.add_argument('--allemail', action='store_true', 
                            help='Email intermediate log using all emails in $DAILY_DIR/etc/emails (defaults to first email only)')

    args = parser.parse_args()

    args.run_Summarymerge = False # This option is deprecated due to run time, but left here incase we ever want to add it back.
                                  # Currently the uubatchpbs code does not have this syntax in the template/redux Script.


    if args.custom_single_mjd:
        args.custom_1dpost = False
        args.custom_coadd_only = False
        args.end2end = True
    if args.custom_name:
        args.custom = True
        args.run_fieldlist = False
        args.run_fibermap = False
        args.run_reduce2d = False
        args.run_healpix = False
        args.run_spcalib = False
    else:
        args.custom = False
        if args.epoch:
            args.run_fibermap = False
            args.run_reduce2d = False
            args.run_healpix = False

    if (args.sdssv is True):
        args.MWM_fluxer      = True
        args.no_reject       = True
        args.run_Summarymerge  = False
        args.map3d = 'merge3d'
        if args.mjdstart is None and args.mjd is None:
            args.mjdstart    = 59146
        if args.field is None and args.fieldstart is None:
            args.fieldstart  = 15000

    if args.allemail:
        args.email = True

    config.load(args.queue_config, queue_config_file= args.queue_config_file,
                 config_name=args.config, config_file=args.config_file)
    
    config_par = {'no_write': args.no_write,
                  'mem_per_cpu':args.mem_per_cpu,
                  'wall':args.walltime,
                  'nodes':args.nodes,
                  'ppn':args.ppn,
                  'no_submit': args.nosubmit,
                  'nbundle':args.nbundle}
    
    for name, val in config_par.items():
        config.queue.set(name, val)

    if args.custom is not None:
        args.skip2d  = True

    if not args.obs:
        args.obs = ['apo','lco']

    args.obs = list(set(args.obs))

    exclude_groups = [queuegroup,configgrp]

    exclude_args = set()
    for g in exclude_groups:
        exclude_args.update(action.dest for action in g._group_actions)
    

    for arg, value in vars(args).items():
        if value is not None and arg not in exclude_args:
            if not update_key(config.pipe, arg, value):
                print(f"[DEBUG] Key '{arg}' not found anywhere in config.")

    queue = uubatchpbs()



#!/usr/bin/env python3
from boss_drp.run.uurundaily import uurundaily, parseNumList, SkipPlanAction
from boss_drp.utils.argparse_help import MultiBoolAction

from boss_drp.Config import config, update_key
from boss_drp.run.queue import hasslurm
import argparse
import os.path as ptt
import sys
import os



if __name__ == '__main__' :
    """
    Batch process Spectro-2D and Spectro-1D reductions
    """
    parser = argparse.ArgumentParser(
            prog=ptt.basename(sys.argv[0]),
            description='Process the BOSS data for a single MJD end-to-end (including plan files)')
    fmjd_group = parser.add_argument_group('Field-MJD Selection', 'Arguments to control the Field-MJD Selection to run')
    Step_group = parser.add_argument_group('Pipeline Steps', 'Arguments to control which steps of the full pipeline are run')
    debug_group = parser.add_argument_group('Debug', 'Arguments to saving of optional debugging files')
    short_group = parser.add_argument_group('Shortcut Options', 'Arguments to set multiple options at once for various defaults')
    opt_group = parser.add_argument_group('Pipeline Options', 'Arguments to set the misc pipeline options')
    configgrp = parser.add_argument_group('Configurations', 'Configuration Files and names')
    queue_group = parser.add_argument_group('Queue Options', 'Arguments to set the Queue options')
    
    parser.add_argument('--module', type=str, help='Module for daily run', default=None)

    
    fmjd_group.add_argument('--apo', action = 'append_const', help='Run apo', const='apo', dest='obs')
    fmjd_group.add_argument('--lco', action = 'append_const', help='Run lco', const='lco', dest='obs')
    fmjd_group.add_argument('--mjd', type=int, help='Manually run for a single/list of mjd (does not update nextmjd.par)', nargs='*')
    fmjd_group.add_argument('--range_mjd', type=parseNumList, help='Manually run for a range of mjds (does not update nextmjd.par)')
    fmjd_group.add_argument('--no_dither', dest='dither', action='store_false', default=True, 
                            help='Skip Dither Engineering Fields')
    fmjd_group.add_argument('--epoch', action='store_true', help='Run Epoch Coadds')
            
    Step_group.add_argument('--no_traceflat', action='store_false', dest='run_spTrace',#dest='traceflat', 
                            help='Skip Building and using TraceFlats', default=True)
    #Step_group.add_argument('--traceflat', action='store_true', help=argparse.SUPPRESS)
    Step_group.add_argument('--force_arc2trace','--a2t', dest='force_arc2trace',#dest='a2t',
                            help='Force Use of Arc2Trace', action='store_true')
    Step_group.add_argument('--no_fibermap', action='store_false', help='Skip Pre-Run of readfibermap',
                            dest='run_fibermap', default=True)
    Step_group.add_argument('--no_prep', action=MultiBoolAction, dests=['run_fibermap','run_spTrace'], 
                            nargs=0, const=False, default=True,dest=argparse.SUPPRESS,
                            help='Skip building TraceFlats and spfibermaps before pipeline run')
    Step_group.add_argument('--skip_plan', nargs='?', const=True, choices=['pipe', 'trace', True, 'all'],
                            action=SkipPlanAction, default=False,
                            help="Skip the given plan {pipe,trace,all (flagging --skip_plan with no name will default to all)}")
    Step_group.add_argument('--clobber', nargs='*', choices=['spPlans','fibermap', 'trace', True, 'all'],
                            default=False,
                            help=("Clobber uubatchpbs + a combo of spPlan, fibermap, and TraceFlat run "+
                                  "{fibermap,trace, all (flagging --clobber with name will default to all)}"))
    Step_group.add_argument('--no_healpix','--nohp', action='store_false', help='Turn off copy to healpix', 
                           dest='run_healpix', default=True)
    Step_group.add_argument('--summary', action='store_true', help='Build Summary Files')

    debug_group.add_argument('--saveraw', action='store_true', help='save sdssproc outputs')
    debug_group.add_argument('--debug', action='store_true', help='save extraction debug files')
    
    short_group.add_argument('--tagged', action='store_true', dest='tagged_run',help='sets --merge3d --sc tagged_daily --no_dither --monitor --allemail')
    short_group.add_argument('--daily', action='store_true', dest='daily_run',  help='sets --merge3d --sc fast_daily --monitor --allemail --no_healpix')
    short_group.add_argument('--dev', action='store_true', dest='dev_run',      help='sets --merge3d --sc tagged_daily --no_dither --monitor --no_healpix')
    

    opt_group.add_argument('--topdir', type=str, help='Optional override value for the environment variable $BOSS_SPECTRO_REDUX',
                           default = os.getenv('BOSS_SPECTRO_REDUX'), dest = 'BOSS_SPECTRO_REDUX')
    opt_group.add_argument('--run1d', type=str, help='Optional override value for the enviro variable $RUN1D',
                           default=os.getenv('RUN2D'), dest='RUN2D')
    opt_group.add_argument('--run2d', type=str, help='Optional override value for the enviro variable $RUN2D', 
                           default=os.getenv('RUN1D'), dest='RUN1D')

    opt_group.add_argument('--nodist', action='store_false',dest='nodist', help=argparse.SUPPRESS)
    opt_group.add_argument('--dist',   action='store_true', dest='nodist',
                             help='unsets --nodist and reactivates the flux distortion corrections')
    opt_group.add_argument('--bay15', action='store_const',dest='map3d', const='bayestar15', 
                           help='Set map3d to bayestar15 model')
#    opt_group.add_argument('--eden23', action='store_const', dest='map3d', const='edenhofer2023', 
#                           help='Set map3d to edenhofer2023 model')
    opt_group.add_argument('--merge3d', action='store_const',dest='map3d', const='merge3d', 
                           help='Set map3d to best 3d model')
    opt_group.add_argument('--batch', action='store_true', help='run for multiple mjds in a single batch', dest='batch_mjd')
    opt_group.add_argument('--nodb', action='store_true', help='skip Database operations', dest='no_db')
    opt_group.add_argument('--monitor', action='store_true', help='Monitors pipeline status', dest='pipe_monitor')
    opt_group.add_argument('--pause', type=int, help='Pause time (s) in status updates', default=15*60)
    opt_group.add_argument('--allemail', action='store_true', help='Email intermediate log using all emails in $DAILY_DIR/etc/emails (defaults to first email only)')

    configgrp.add_argument('--pipe_config', '--pc', help='Queue Config name', default='boss_drp', dest='config')
    configgrp.add_argument('--pipe_config_file', '--pcf', help='Queue Config File Path', default=None, dest='config_file') 
    configgrp.add_argument('--queue_config', '--qc', help='Queue Config name', default=None)
    configgrp.add_argument('--queue_config_file', '--qcf', help='Queue Config File Path', default=None)

    queue_group.add_argument('--no_write', action='store_true', help='skip writing and submitting job')
    queue_group.add_argument('--nosubmit', action='store_true', help='Skip submitting uubatch job (ideal for allowing editting of plans)')
    queue_group.add_argument('--walltime', help='Wall time in hours', type=str, default=None)
    queue_group.add_argument('--mem_per_cpu', help='Memory allocated per CPU', type=str, default=None)
    queue_group.add_argument('--nbundle', help='Number of jobs to bundle', type=int, default= None)

    args = parser.parse_args()

    if not hasslurm:
        exit()


    if args.BOSS_SPECTRO_REDUX is not None:
        os.environ['BOSS_SPECTRO_REDUX'] = args.BOSS_SPECTRO_REDUX
    if args.RUN2D is not None:
        os.environ['RUN2D'] = args.RUN2D
    if args.RUN1D is not None:
        os.environ['RUN1D'] = args.RUN1D

    if (args.tagged_run) or (args.daily_run) or (args.dev_run):
        args.map3d = 'merge3d'
        args.pipe_monitor = True
    
    if args.tagged_run:
        args.dither = False
        args.allemail = True
        if args.queue_config is None:
            args.queue_config = 'tagged_daily'
    elif args.daily_run:
        args.allemail = True
        args.run_healpix = False
        if args.queue_config is None:
            args.queue_config = 'fast_daily'
    elif args.dev_run:
        args.dither = False
        args.run_healpix = False
        if args.queue_config is None:
            args.queue_config = 'tagged_daily'
    elif args.queue_config is None:
        args.queue_config = 'tagged_daily'

    config.load(args.queue_config, queue_config_file= args.queue_config_file,
                 config=args.config, config_file=args.config_file)

    config_par = {'mem_per_cpu':args.mem_per_cpu,
                  'wall':args.walltime,
                  'no_submit': args.nosubmit,
                  'no_write': args.no_write,
                  'nbundle':args.nbundle}
    
    for name, val in config_par.items():
        config.queue.set(name, val)

 
    if args.range_mjd is not None:
        if args.mjd is not None:
            args.mjd.extend(args.range_mjd)
        else:
            args.mjd = args.range_mjd

    if not isinstance(args.clobber, list):
        args.clobber = [args.clobber]
    for c in args.clobber:
        if c is True:
            for key in config.pipe.get('Clobber').keys():
                config.pipe[f'Clobber.{key}'] = True
        elif type(c) is bool:
            pass
        elif c.lower() == 'fibermap':
            config.pipe['Clobber.clobber_pipe']
            config.pipe[f'Clobber.clobber_fibermap'] = True
        elif c.lower() == 'trace':
            config.pipe['Clobber.clobber_pipe']
            config.pipe[f'Clobber.clobber_spTrace'] = True
        elif c.lower() == 'all':
            for key in config.pipe.get('Clobber').keys():
                config.pipe[f'Clobber.{key}'] = True

    if not isinstance(args.skip_plan,list):
        args.skip_plan = [args.skip_plan]
    for sp in args.skip_plan:
        if sp is True:
            config.pipe['Stage.run_plan']
            config.pipe['Stage.run_spTrace_plan']
        elif type(sp) is bool:
            pass
        elif sp.lower() == 'pipe':
            config.pipe['Stage.run_plan']
        elif sp.lower() == 'trace':
            config.pipe['Stage.run_spTrace_plan']
        elif sp.lower() == 'all':
            config.pipe['Stage.run_plan']
            config.pipe['Stage.run_spTrace_plan']


    if args.module is None:
        args.module = os.getenv('MODULE', default=None)
        if args.module is None:
            args.module = os.getenv('RUN2D', default=None)
            if args.module is None:
                args.module = 'bhm/master'
            elif args.dev:
                args.module = f'work/{args.module}'
            else:
                args.module = f'bhm/{args.module}'
                
    # if args.a2t:
    #     args.traceflat = True

    if not args.obs:
        args.obs = ['apo','lco']

    # for obs in args.obs:
    #     uurundaily(args.module, args.obs, mjd=args.mjd, clobber=args.clobber, 
    #             saveraw=args.saveraw, skip_plan=args.skip_plan, 
    #             batch=args.batch, debug=args.debug,
    #             nodb= args.nodb, epoch = args.epoch, build_summary = args.summary,
    #             pause = args.pause, monitor=args.monitor, map3d=args.map3d,
    #             no_dither=args.no_dither,a2t=args.a2t, traceflat = args.traceflat,
    #             no_prep = args.no_prep, nodist=args.nodist, no_fibermap = args.no_fibermap, 
    #             allemail=args.allemail, no_healpix=args.no_healpix)

    exclude_groups = [queue_group,configgrp]

    exclude_args = set()
    for g in exclude_groups:
        exclude_args.update(action.dest for action in g._group_actions)
    
    exclude_args.update(['range_mjd','tagged_run','dev_run','daily_run','monitor'])

    runobs = args.obs

    for obs in runobs:
        args.obs = [obs]
        for arg, value in vars(args).items():
            if value is not None and arg not in exclude_args:
                if not update_key(config.pipe, arg, value):
                    print(f"[DEBUG] Key '{arg}' not found anywhere in config.")


        uurundaily()
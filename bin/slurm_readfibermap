#!/usr/bin/env python3

import argparse
from boss_drp.run.slurm_readfibermap import slurm_readfibermap
from boss_drp.Config import config, update_key

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description='Create daily field merge queue job. Without access to the SDSS Slurm package, it prints the commands for manual execution')
    parser.add_argument('--topdir', default = None, help = 'Boss Spectro Redux base directory')
    parser.add_argument('--run2d',  default = None, help = 'Run2d')

    parser.add_argument('--clobber', action='store_true', help='Clobber spfibermaps', dest='clobber_fibermap')
    parser.add_argument('--apo', action = 'append_const', help='Run apo', const='apo', dest='obs')
    parser.add_argument('--lco', action = 'append_const', help='Run lco', const='lco', dest='obs')
    parser.add_argument('--v_targ', help='SDSS-V MOS Targeting Product Version  (for no Database access use)', dest='V_TARG')

    mjdgroup = parser.add_argument_group('Select MJDs')
    mjdgroup.add_argument('--mjd', nargs='*', help='MJD dates to reduce; default="*"', type=int)
    mjdgroup.add_argument('--mjdstart', help='Starting MJD', default=None, type=int)
    mjdgroup.add_argument('--mjdend', help='Ending MJD', default=None, type=int)

    configgrp = parser.add_argument_group('Configurations')
    configgrp.add_argument('--pipe_config', '--pc', help='Queue Config name', default='boss_drp', dest='config')
    configgrp.add_argument('--pipe_config_file', '--pcf', help='Queue Config File Path', default=None, dest='config_file')
    configgrp.add_argument('--queue_config', '--qc', help='Queue Config name', default='readfibermap')
    configgrp.add_argument('--queue_config_file', '--qcf', help='Queue Config File Path', default=None)

    queuegroup = parser.add_argument_group('Queue Options')
    queuegroup.add_argument('--mem_per_cpu', help='Memory allocated per CPU', type=str)
    queuegroup.add_argument('--walltime', help='Wall time in hours', type=str)
    queuegroup.add_argument('--ppn', help='Number of processors per node', type=int)
    queuegroup.add_argument('--nbundle', help='Number of jobs to bundle', type=int, default= None)

    args = parser.parse_args()

    obs = args.obs

    if len(obs)== 0:
        obs = ['apo','lco']

    config.load(args.queue_config, queue_config_file= args.queue_config_file,
                 config_name=args.config, config_file=args.config_file)
    config_par = {'mem_per_cpu':args.mem_per_cpu,
                  'wall':args.walltime,
                  'ppn': (args.ppn or 20),
                  'nbundle':args.nbundle}
    for name, val in config_par.items():
        config.queue.set(name, val)

    exclude_groups = [queuegroup,configgrp]

    exclude_args = set()
    for g in exclude_groups:
        exclude_args.update(action.dest for action in g._group_actions)
    

    for arg, value in vars(args).items():
        if value is not None and arg not in exclude_args:
            if not update_key(config.pipe, arg, value):
                print(f"[DEBUG] Key '{arg}' not found anywhere in config.")


    slurm_readfibermap()



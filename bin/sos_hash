#!/usr/bin/env python3
from boss_drp.utils.hash import create_hash, check_hash
from boss_drp.sos.sos_classes import SOS_config
import argparse
from os import getenv, environ
import os.path as ptt
import time


if __name__ == "__main__":
    descr = "Create or check the SOS file hash"
    parser = argparse.ArgumentParser(description=descr, usage="sos_hash MJD")
    parser.add_argument("--mjd", type=int, help="MJD to process",required=True)
    parser.add_argument("--redo",'-t', action="store_true",help='use sosredo directory (same as SOS -t or --redoMode option)')
    parser.add_argument("--test",'-d', action="store_true",help='use sosredo/dev directory (same as SOS -d or --test option)')
    parser.add_argument("--utah",'-u', action="store_true",help='use utah test directory (same as SOS --utah option)')
    parser.add_argument("--create", action="store_true", help="Create the Hash file")
    parser.add_argument("--check", action="store_true", help="Check the SOS Hash")
    parser.add_argument("--transfer",action="store_true", help="Check the SOS Hash of a Utah transfer")
    parser.add_argument("--lco", action="store_true", help="Build/check for lco at Utah")
    parser.add_argument("--dummy", action="store_true", help="Create a dummy file to prevent an empty hash file")
    args = parser.parse_args()

    
    if args.transfer:
        sosdir = getenv('BOSS_SOS_S') if args.lco else getenv('BOSS_SOS_N')

    else:
        if args.utah:
            environ['OBSERVATORY'] = 'APO' if not args.lco else 'LCO'
        config = SOS_config.setup(mjd=args.mjd, redo=args.redo, test=args.test, utah=args.utah)
        sosdir = config.sosdir

    sosdir = ptt.join(sosdir, f'{args.mjd}')
    if args.create:
        i = 0
        while create_hash(sosdir, dummy=args.dummy):
            i += 1
            if i >= 10:
                print("Error: Could not unlock sha1sum file")
                break
            time.sleep(3)
            print("\nsha1sum is locked")

    if args.check:
        check_hash(sosdir, verbose = True)


#!/usr/bin/env python3
from boss_drp.prep.spplan_target import batch, CustomCoadd
from boss_drp.utils import load_env
from boss_drp.Config import config, update_key

from os import getenv, makedirs
import os.path as ptt
import sys
import argparse

########################
if __name__ == '__main__' :

    parser = argparse.ArgumentParser(
        prog=ptt.basename(sys.argv[0]),
        description='Build SDSSID/CatalogID Combine Plan')

    configgrp = parser.add_argument_group('Configurations')
    configgrp.add_argument('--pipe_config', '--pc', help='Queue Config name', default='boss_drp', dest='config')
    configgrp.add_argument('--pipe_config_file', '--pcf', help='Queue Config File Path', default=None, dest='config_file')


    General = parser.add_argument_group(title='General', description='General Setup Options')
    General.add_argument('--topdir',         help='Base run2d directory to BOSS_SPECTRO_REDUX environmental variable', 
                         dest='BOSS_SPECTRO_REDUX')
    General.add_argument('--run2d',          help='Override value for the environment variable $RUN2D', dest='RUN2D')
    General.add_argument('--run1d',          help='Override value for the environment variable $RUN1D', dest='RUN1D')
    General.add_argument('--obs', help='Observatory {apo,lco}', nargs='*', default=None, type=str.lower, choices=['apo','lco'])
    General.add_argument('--apo', action = 'append_const', help='Run apo', const='apo', dest='obs')
    General.add_argument('--lco', action = 'append_const', help='Run lco', const='lco', dest='obs')

    Filter_grp = parser.add_argument_group(title='MJD Filtering', description='MJD Filtering Options')
    Filter_grp.add_argument('--mjd', help = 'Use data from these MJDs.', required=False)
    Filter_grp.add_argument('--mjdstart', help = 'Starting MJD', required=False)
    Filter_grp.add_argument('--mjdend', help = 'Ending MJD', required=False)


    group = parser.add_mutually_exclusive_group(required=True)
    group.add_argument('--manual', help = 'Manaully run a Coadd Schema (from coaddfile if only name is set)', 
                       action ='store_false', dest='batch', default = True)
    group.add_argument('--batch', help = 'Batch run all active Coadd Schema in batch file located {topdir}/{run2d}/{name}', action='store_true')

    custom_grp = parser.add_argument_group(title='spPlan Epoch', description='spPlan Epoch Setup Options')

    custom_grp.add_argument('--name', help = 'Name of Custom Coadd', dest='custom_name')
    custom_grp.add_argument('--coaddfile', default = None, help = 'File of store Coadding Schema', dest='schema_file')

    custom_grp.add_argument('--clobber', help = "If set, then over-write conflicting plan files", 
                            action='store_true', required=False, dest='clobber_plan')
    custom_grp.add_argument('--logfile', help="File for logging", dest='customplan_logfile')

    custom_grp.add_argument('--DR', action = 'store_true', help = 'DR/IPL Batch Coadding')
    custom_grp.add_argument('--cartons', nargs='*', help = "list of cartons")
    custom_grp.add_argument('--catalogids', nargs='*', help = "list of sdss_ids (or catalogids)")
    custom_grp.add_argument('--program', nargs='*', help = 'list of programs')
    custom_grp.add_argument('--coadd_mjdstart', help = 'First Coadd MJD to include', required=False)
    custom_grp.add_argument('--rerun1d', action = 'store_true', help = 'Provides flag for coadd to be rerun though 1D analysis')
    custom_grp.add_argument('--use_catid', '-u', action = 'store_true', help='Uses CatalogID rather then sdss_id')
    custom_grp.add_argument('--use_firstcarton', action = 'store_true', help='Use Firstcarton only for carton match (dont look at db)')
    custom_grp.add_argument('--useDB', action = 'store_true', help='Use sdss targetdb instead of the Semaphore targeting flag (if not use_firstcarton)')

    args = parser.parse_args()


    if not args.obs:
        args.obs = None

    exclude_groups = [configgrp]
    exclude_args = set()
    for g in exclude_groups:
        exclude_args.update(action.dest for action in g._group_actions)


    for arg, value in vars(args).items():
        if value is not None and arg not in exclude_args:
            if not update_key(config.pipe, arg, value):
                print(f"[DEBUG] Key '{arg}' not found anywhere in config.")

    if ((args.DR is False) & (args.cartons is None) & (config.pipe['fmjdselect.mjd'] is None) &
        (config.pipe['fmjdselect.mjdstart'] is None) & (config.pipe['fmjdselect.mjdend'] is None) &
        (config.pipe['plan.custom.rerun1d'] is None) & (config.pipe['plan.custom.program'] is None)): 
       
        config.pipe['plan.custom.batch'] = True

    if config.pipe['plan.custom.batch']: 
        batch()
    else:
        CustomCoadd(config.plan['customSettings.custom_name'],config.pipe['general.BOSS_SPECTRO_REDUX'],
                    config.pipe['general.RUN2D'],config.pipe['general.RUN1D'], cartons = config.pipe['plan.custom.cartons'],
                    catalogids = config.pipe['plan.custom.catalogids'], obs = config.pipe['fmjdselect.obs'], 
                    clobber = config.pipe['Clobber.clobber_plan'], logfile = config.pipe['plan.custom.customplan_logfile'],
                    mjd = config.pipe['fmjdselect.mjd'], mjdstart = config.pipe['fmjdselect.mjdstart'],
                    mjdend = config.pipe['fmjdselect.mjdend'], program = config.pipe['plan.custom.program'],
                    rerun1d = config.pipe['plan.custom.rerun1d'], use_catid = config.pipe['plan.custom.use_catid'],
                    use_firstcarton=config.pipe['plan.custom.use_firstcarton'],
                    coadd_mjdstart=config.pipe['plan.custom.coadd_mjdstart'], useDB=config.pipe['plan.custom.useDB'])



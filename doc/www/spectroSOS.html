
<HTML>
<HEAD>
   <TITLE>Son-of-Spectro Documentation</TITLE>
</HEAD>
<BODY TEXT="#000000" LINK="#0000ff" VLINK="#800080" BGCOLOR="#eeeeee"
ALINK="#FF0000">

<CENTER><H1>Son-of-Spectro (SOS) Documentation</H1></CENTER>

This document desribes the real-time reductions of spectroscopic data
taken with the SDSS 2.5-m.  These reductions are robotically posted
to the
<A HREF="http://sos.apo.nmsu.edu/logfile-current.html">
<!--
<A HREF="http://hoggpt.apo.nmsu.edu/sos/logfile-current.html">
-->
SOS web page</A> and archived at the
<A HREF="http://www.astro.princeton.edu:81/sdss-speclog/INDEX.html">
Princeton mailing list</A>.

<P>
In this document:
<UL>
  <LI><A HREF="#launch">How to Launch Son-of-Spectro</A>
  <LI><A HREF="#version">Backing out to an older version</A>
  <LI><A HREF="#install">Installing a new version</A>
  <LI><A HREF="#howwork">How Son-of-Spectro Works</A>
  <LI><A HREF="#headers">FITS header cards (and how to change them)</A>
  <LI><A HREF="#outputs">Son-of-Spectro Outputs</A>
  <UL>
     <LI><A HREF="#outputs_table">Tabluated values</A>
     <LI><A HREF="#outputs_warning">WARNING and ABORT messages</A>
     <LI><A HREF="#outputs_log">Log files</A>
     <LI><A HREF="#outputs_figure">S/N figures</A>
  </UL>
  <LI><A HREF="#trouble">Trouble-shooting Son-of-Spectro</A>
  <LI><A HREF="#rereduce">Re-Reducing (Failed) Exposures</A>
</UL>

<P>
Related documents:
<UL>
  <LI><A HREF="spectro_apodisplay.html">Displaying Spectra at APO</A>
</UL>

<H2><A NAME="launch">How to Launch Son-of-Spectro</A></H2>

<P>
Son-of-Spectro is a cron job that runs from the "observer" account
on "sos.apo.nmsu.edu".  It should always be running, and
should even recover (as any cron job) if that machine is power-cycled.
It has been run previously on the machines "hoggpt.apo" and
"plate-mapper.apo".

<P>
Log into "sos.apo" as user "observer".  Check if the SOS is running
by typing:
<DL><DD><PRE>
  % sos_status
</PRE></DD></DL>
If it is <B>not</B> running, then you will see a response beginning with:
<DL><DD><PRE>
  The Son-of-Spectro cron job is NOT running for USER=observer MACHINE=sos.
</PRE></DD></DL>
If it <B>is</B> running, then you will see a response beginning with:
<DL><DD><PRE>
  The Son-of-Spectro cron job IS running for USER=observer MACHINE=sos.
</PRE></DD></DL>
This is then followed with some other information that may be useful
for trouble-shooting.

<P>
To start up SOS, type:
<DL><DD><PRE>
  % sos_start
</PRE></DD></DL>

<P>
To stop up SOS, type:
<DL><DD><PRE>
  % sos_stop
</PRE></DD></DL>

<P>
All of these commands can also be run from a remote machine.
A second argument should be the machine name with an optional user-name, i.e.:
<DL><DD><PRE>
  % sos_status sos
  % sos_status observer@sos.apo.nmsu.edu
</PRE></DD></DL>

<P>
Note that the following directories should exist on sos.apo and be
write-able by the observer account:
<DL><DD><PRE>
  /data/spectro
  /data/spectro/astrolog
  /data/spectro/spectrologs
  /data/spectro/spectrologs/html
</PRE></DD></DL>

<P>
Note that the following link should exist if running on sos.apo:
<DL><DD><PRE>
  ln -s /usr/local/www/data /data/spectro/spectrologs/html
</PRE></DD></DL>
Note that the following link should exist if running on hoggpt.apo:
<DL><DD><PRE>
  ln -s /data/spectro/spectrologs/html /usrdevel/skent/inventory/www/apo2d
</PRE></DD></DL>
Note that the following link should exist if running on plate-mapper.apo:
<DL><DD><PRE>
  ln -s /data/spectro/spectrologs/html /home/skent/inventory/www/apo2d
</PRE></DD></DL>

<H2><A NAME="version">Backing out to an older version</A></H2>

<OL>
<LI>
You can run a different version of Son-of-Spectro by setting up
the relevant version of idlspec2d before you launch it with "sos_start".
This should be done from the "observer" account on "sos.apo.nmsu.edu".
Check which version of the code is being run with:
<DL><DD><PRE>
  % sos_status
</PRE></DD></DL>
Stop this version from running with:
<DL><DD><PRE>
  % sos_stop
</PRE></DD></DL>

<LI>
Wait a minute or two for any running SOS reductions to complete.

<LI>
The output files of different versions of Son-of-Spectro
can be incompatable with one another.
We recommend deleting (or at least renaming) the
current working directory:
<DL><DD><PRE>
  mv /data/spectro/spectrologs/$MJD /data/spectro/spectrologs/$MJD.old
</PRE></DD></DL>
The file whose existence will cause a new version of code to crash is:
<DL><DD><PRE>
  /data/spectro/spectrologs/$MJD/logfile-$MJD.fits
</PRE></DD></DL>

<LI>
Now set up and start the new version:
<DL><DD><PRE>
  % setup idlspec2d v4_9_1
  % sos_start
</PRE></DD></DL>
If you type "sos_status", it should tell you which version is now running.

</OL>

<P>
Note that Son-of-Spectro is actually general enough to be run from any
account on any remote computer.  The only requirements are as following:
<UL>
<LI>The directory /data/spectro must exist on the remote machine,
    and be write-able by the user.
<LI>This user@machine must have permission to copy files with "ssh"
    "from sdsshost.apo.nmsu.edu".  This must be set up to work without
    typing a passphrase.
</OL>

<H2><A NAME="install">Installing a new version</A></H2>

<P>
Follow the instructions for
<A HREF="idlspec2d_install.html#install_evil">CVS install w/UPS and evilinstall</A>.
This is the short-cut to installing code using UPS.  It will cvs-export
code, build it, install it, and declare it current.  If the code is already
installed, then it simply declares it the specified version current.

<P>
Now you are ready to <A HREF="#launch">launch</A> this new version of the code.

<H2><A NAME="howwork">How Son-of-Spectro Works</A></H2>

<P>
Son-of-Spectro is a cron job that runs from the "observer" account
on "sos.apo.nmsu.edu".  This cron job invokes rsync once
every minute to copy raw spectro data from "sdsshost" to "sos.apo",
then launches a package of shell scripts and IDL commands to reduce
the data one frame at a time.  It is part of the <B>idlspec2d</B> data product.

<P>
There are actually <B>two</B> rsync processes that run, one for the blue
camera images and one for the red.  We did this so that both processors on the
computer can be utilized.  All 4 cameras should be reduced for an exposure
within a few minutes.

<P>
The raw data is copied into these directories on sos.apo:
<DL><DD><PRE>
  /data/spectro/astrolog/$MJD  - Copy of the same from sdsshost
  /data/spectro/$MJD           - Copy of /astrolog from sdsshost
</PRE></DD></DL>

<P>
The data reduction is not the same as the full-up spectroscopic pipeline.
A number of shortcuts are taken to speed up the reductions and make them
very robust.  For example, boxcar extraction of the spectra is used instead
of optimal extraction.

<P>
The reduced data will appear in the directory:
<DL><DD><PRE>
  /data/spectro/spectrologs/$MJD
</PRE></DD></DL>
Files like the following can be found in that directory:
<DL><DD><PRE>
  splog-b1-00006541.log              - Text history of exp #6541 reduction
  tset-51795-0389-00006541-b1.fits   - Fiber traces (from flat exposure #6541)
  wset-51795-0389-00006542-r1.fits   - Wavelength solution (from arc exp #6542)
  fflat-51795-0389-00006542-b1.fits  - Flat-field vectors (w/ arc exp #6542)
  sci-0389-b2-00006546.fits          - Science spectra for plate 389 (exp #6546)
  logfile-51795.fits                 - Summary info for night in FITS format
  logfile-51795.html                 - Summary info for night in HTML format
  snplot-51795-0389.ps               - Signal-to-noise plot for nplate 389
</PRE></DD></DL>
If a particular frame does not get reduced and appear on the Son-of-Spectro
web site, then you can look at its log file (splog*.log).  If the file
does not end with the line "Finished at", then that exposure must have
crashed.

<P>
The HTML files and S/N plots for the web page are copied into the directory:
<DL><DD><PRE>
  /data/spectro/spectrologs/html
</PRE></DD></DL>
The most recent HTML file has a second copy as the file "logfile-current.html".
This is the file pointed to by the
<A HREF="http://sos.apo.nmsu.edu/logfile-current.html">
SOS web page</A>.

<H2><A NAME="headers">FITS header cards (and how to change them)</A></H2>

<H4><A NAME="headers_required">Required FITS header cards</A></H4>

<P>
The following FITSheader cards are required to be correct for either
Son-of-Spectro or Spectro-2D to reduce the data properly:
<PRE>
EXPOSURE= Exposure number.  We always override the value of this keyword
          with the exposure number in the file name.
CAMERAS = Camera name, e.g. "b1".  We always override the value of this keyword
          with the exposure number in the file name.
FLAVOR  = The flavor of the observation, which can be "bias", "dark",
          "arc", "flat", and "science" or "target".  Files with other
          flavors, such as "unknown", are not reduced.
MJD     = MJD of observation, which must agree with the directory in which
          the file resides, "/data/spectro/$MJD".
PLATEID = The plate ID, which must match that in the NAME header card.
NAME    = Plug name, e.g. "0328-52277-01" for plate 328, plugged on 52277
          with a plugging ID of 01.  We assume that there is a plug-map
          file at APO with the name "/astrolog/$MJD/plPlugMapM-$NAME.par".
EXPTIME = The exposure time, which is used along with TAI-BEG to compute
          the airmass.  It is also used to determine whether the sky
          brightness or scattered light is larger than tolerances.
TAI-BEG = The TAI time for the beginning of the exposure, which is used
          to compute the airmass and sky-brightness gradients for sky-
          subtraction.  If this keyword is missing, we guess it from
          EXPTIME and TAI.
TAI-END = Used with TAI-BEG.  If this keyword is missing, we guess it from
          EXPTIME and TAI.
TAI     = This keyword is used if TAI-BEG,TAI-END are missing.
FFS     = Flat-field screen positions, which should be
          "0 0 0 0 0 0 0 0" for science exposures (all petals open)
          "1 1 1 1 1 1 1 1" for flat or arc exposures (all petals closed)
FF      = Flat-field (quartz) lamp status, which should be
          "0 0 0 0" for science or arc exposures (all off)
          "1 1 1 1" for flat exposures (all on)
NE      = Neon lamp status, which should be
          "0 0 0 0" for science or flat exposures (all off)
          "1 1 1 1" for arc exposures (all on)
HGCD    = HgCd lamp status, which should be
          "0 0 0 0" for science or flat exposures (all off)
          "1 1 1 1" for arc exposures (all on)
OBSCOMM = This keyword is used to identify the dithered flat sequence
          taken in the Monthly Checkout with the "specFlats" script in SOP.
          The flats in this sequence must have OBSCOMM="{dithered flats-flat}".
          The arcs in this sequence must have OBSCOMM="{dithered flats-arc}".
          This keyword also identifies the Hartmann focus exposures, with
          the entries OBSCOMM="{{focus, hartmann l}" or "{focus, hartmann r}".
</PRE>

<H4><A NAME="headers_informational">Informational FITS header cards</A></H4>

<P>
The following FITS header cards are informational.  We would very much
appreciate the observers to correct errors in these keywords so that
our book-keeping of survey progress is done properly:
<PRE>
TILEID  = Tile ID for this plate from the plug-map file
RA      = Right ascension of telescope boresight (in degrees)
DEC     = Declination of telescope boresight (in degrees)
RADEG   = Right ascension of plate center for plug-map file (in degrees)
DECDEG  = Declination of plate center for plug-map file (in degrees)
AIRTEMP = Temperature (deg C)
</PRE>

<H4><A NAME="headers_change">How to change FITS header cards</A></H4>

<P>
Incorrect FITS header cards for the raw spectro sdR files can be
corrected by adding "ophdrfix" entries in the sdReport file
"/astrolog/$MJD/sdReport-$MJD.par".
This structure should have the following definition in the sdReport file:
<PRE>
   typedef struct {
     char fileroot;    # Root of file name, without any ".fit" suffix
     char keyword;     # Keyword name
     char value;       # Keyword value (as a string)
   } ophdrfix;
</PRE>

<P>
Following are some examples of what should appear in the sdReport files
in order to correct faulty headers.  (The typedef struct above must
also be in the file.)
<UL>
<LI>
Example 1: The exposure time is in the file sdR-b1-00001142.fit should be
60 seconds:
<PRE>
   ophdrfix sdR-b1-00001142 EXPTIME  60
</PRE>
<LI>
Example 2: Exposure number 1234 was bad, and should be given an 'unkown'
flavor for all cameras:
<PRE>
   ophdrfix sdR-??-00001234 FLAVOR  "'unknown'"
</PRE>
<LI>
Example 3: The mapping name for all cameras of exposures 1137-1139
should be '0198-51433-01':
<PRE>
   ophdrfix sdR-??-0000113[7-9] NAME     "'0198-51433-01'"
</PRE>
<LI>
Example 4: Telescope status information is missing for the pre-flat
exposure 10850:
<PRE>
   ophdrfix sdR-??-00010850  FFS   "'1 1 1 1 1 1 1 1'"
   ophdrfix sdR-??-00010850  FF    "'1 1 1 1 '"
   ophdrfix sdR-??-00010850  NE    "'0 0 0 0 '"
   ophdrfix sdR-??-00010850  HGCD  "'0 0 0 0 '"
</PRE>
</UL>

<P>
If you have edited the sdReport file and need to re-reduce an exposure,
you can do so with the <A HREF="#rereduce">sos_redo</A> command.
When Son-of-Spectro reads in the raw FITS files, it then patches the
headers with the information in the ophdrfix entries of the sdReport file.
But note that the one piece of information that cannot be patched this
way is MJD, since we need the MJD in order to find the correct sdReport file!!

<H2><A NAME="outputs">Son-of-Spectro Outputs</A></H2>

<H4><A NAME="outputs_table">Tabulated values</A></H4>

<P>
Son-of-Spectro reduces four flavors of observations:
bias/dark, flat, arc, & science/smear.  Select information is tabulated
for each of these types of observation.  These values are tabulated in
<B><FONT COLOR="#FFFF00">yellow</FONT></B>
if they are going out of spec, and in
<B><FONT COLOR="#FF0000">red</FONT></B>
if they are very much out of spec.

<P>
The values reported are:
<UL>
<LI><B>BIAS/DARK PERCENTILE98</B> <BR>
    The value in electrons of the 98-th percentile on the (overscan-corrected)
    image.  For example, if this is 8, then 98% of the pixels are below 8
    electrons.  Bad regions on the CCD and saturated pixels are excluded
    from this evaluation.
<LI><B>FLAT NGOODFIBER</B> <BR>
    The number of illuminated fibers.  This should be 320 if all the
    fibers are plugged and unbroken.
<LI><B>FLAT XMIN (XMAX)</B> <BR>
    The minimum (maximum) X position of the spectra on the CCD.  If this is
    less than 0 (greater than 2047), then some of the spectra fall off the
    left (right) side of the CCD.
<LI><B>FLAT XSIGMA</B> <BR>
    The profiles in the spatial (X) dimension have a gaussian fit with
    a width of this sigma.  The median of this width is taken independently in
    each of 4 quadrants on a CCD, and the maximum of those 4 values reported.
    If the spectrographs are in focus, then this value should be about 1.0 pix.
    If it is larger, then the spectrographs may be out-of-focus, or the
    slit-heads may not be properly latched.
<LI><B>ARC WAVEMIN (WAVEMAX)</B> <BR>
    The minimum (maximum) wavelength (in Angstroms) of any spectra on this CCD.
    Because of the optical distortions, this is always for the central
    fiber.  The edge fibers have less wavelength coverage.
<LI><B>ARC BESTCORR</B> <BR>
    The linear correlation coefficient between the arc spectra and a template
    arc spectrum.  If they agree perfectly, then this is 1.  The value of
    this correlation is typically 0.80.  If it drops too much lower, then
    the arc spectra do not look as they should.  This could happen if some
    of the arc lines are missing -- if, for example, the Hg lamps all failed.
    If the correlation is less than 0.5 or so, then it's even possible that
    the code has found the incorrect wavelength solution.
<LI><B>ARC NLAMPS</B> <BR>
    The number of arc lines used to generate the wavelength solution.
    There are many more on the red CCD's because neon has many more lines
    there.  If this drops to too few lines, then some of the lamps have not
    turned on properly, have not warmed up, or have warmed up too much.
<LI><B>ARC DISPSIGMA</B> <BR>
    The arc-line profiles in the wavelength (Y) dimension have a gaussian
    fit with a width of this sigma.  The median of this width is taken
    independently in each of 4 quadrants on a CCD, and the maximum of
    those 4 values reported.
    If the spectrographs are in focus, then this value should be about 1.0 pix.
    If it is larger, then the spectrographs may be out-of-focus, or the
    slit-heads may not be properly latched.
    (One would expect that both XSIGMA and DISPSIGMA would go out-of-focus
    at the same time.)
<LI><B>SCIENCE/SMEAR SKY/SEC</B> <BR>
    The median sky counts in electrons per pixel.
    If this is too large, then there must be a light source near the
    telescope, or the night sky (the moon) is bright, or the CCD's are
    warming up and generating dark current.
<LI><B>SCIENCE/SMEAR (S/N)^2</B> <BR>
    The signal-to-noise squared for objects at the fiducial magnitude limit.
    We choose (S/N)^2 because it is an additive quantity with additional
    integration time.  When all the cameras reach a total (S/N)^2 of 15,
    then all these entries turn from red to black, and
    we can declare a plate done.  Exactly how this quantity is
    measured is <A HREF="#outputs_figure">described below</A>.
</UL>

<P>
The exact values of these yellow/red limits and further explanation can
be found in the "idlspec2d" product in the file "examples/opLimits.par".

<H4><A NAME="outputs_warning">WARNING and ABORT messages</A></H4>

<P>
There are a number of
<B><FONT COLOR="#FFFF00">WARNING</FONT></B>
and
<B><FONT COLOR="#FF0000">ABORT</FONT></B>
messages that can appear if the pipeline runs into trouble when processing
a frame.  These messages appear at the bottom of each table.
Each one-line message begins with the relevant file name, WARNING or ABORT,
then a brief plain-text message.

<P>
Note that a single problem may cascade into a large number of warning
messages.  For example, an out-of-focus spectrograph will first produce
the "Median spatial widths" message, probably followed by warnings about
bad sky-residuals.

<P>
The following messages may appear:
<UL>
<LI><B>Empty or invalid sdReport file</B> <BR>
    The sdReport file (sdReport-$MJD.par) in sdsshost:/astrolog/$MJD
    was either improperly copied to sos:/data/spectro/astrolog/$MJD,
    or the file is not a valid Yanny parameter file.  This happened on
    MJD=52311 when somehow the Yanny header was missing from this file.
<LI><B>Exposure number in header disagrees w/filename</B> <BR>
    This means that IOP/SOP is in a very confused state, and it
    is putting a different exposure number in the header (EXPOSURE
    keyword) from what is being used to generate file names.
    You should probably exit SOP, re-start SOP, then issue a "goStare -init".
<LI><B>Fixing shifted rows (from electronics)</B> <BR>
    This is very, very bad.  This is indicative of an electronics problem
    that we first saw on MJD=51578 to 51580 (3 to 5 Feb 2000).
    The raw images have rows shifted to the right, sometimes by
    many pixels.
<LI><B>Fixing dropped-pixel rows (from electronics)</B> <BR>
    This is very bad.  This is indicative of an electronics problem
    that we first saw on MJD=51688 (23 May 2000).
    The raw images actually have some rows shifted by 1 or 2 pixels,
    usually more so near the bottom of the CCD (the first rows to be read).
<LI><B>More than 10% of the image is rejected</B> <BR>
    This is very bad.  This can probably only happen if most of the CCD
    has saturated pixels.
<LI><B>Flat-field screens not closed</B> <BR>
    The "FFS" keyword in the header indicates that at least one of the
    flat-field petals was not closed.  When this happens, the flat or arc
    is not reduced.
<LI><B>Flat-field lamps not turned on</B> <BR>
    The "FF" keyword in the header indicates that at least one of the four
    flat-field lamps was not turned on.
    When this happens, the flat is not reduced.
<LI><B>Reject flat (or arc) ... % bad pixels</B> <BR>
    This condition is triggered when more than 2% of the non-masked pixels
    on the image are bad (saturated).
    When this happens, the flat (or arc) is not reduced.
<LI><B>Reject flat (or arc) ... saturated rows</B> <BR>
    This condition is triggered when there are more than 100 saturated rows
    on the image.
    When this happens, the flat (or arc) is not reduced.
<LI><B>Reject flat as too faint</B> <BR>
    This condition is triggered when the 80-th percentile of the image
    is less than 1000 electrons.
    When this happens, the flat is not reduced.
<LI><B>Reject science ... </B> <BR>
    A science exposure can be rejected if the header keywords indicate
    that the flat-field petals are closed, any flat-field or arc lamps
    are turned on, too many pixels are bad or saturated, or if the
    25-th percentile of the image too large.
<LI><B>Possible Argon lines in superflat</B> <BR>
    Emission lines are present in the quartz-halogen flat-field images,
    which are supposed to be featureless.  When a number follows this message,
    that is a measure of the line strength -- the trigger is set to 0.01,
    but we usually see it as 0.1 to 0.5 when present.
    We have identified these rogue lines as argon.
    JEG's best guess is that these
    contaminating lines come from trace amounts of argon in the HgCd lamps,
    which must still have current running through them when they are supposed
    to be off.  We can still reduce the data with these lines, but you should
    re-open PR 1859 if this problem is seen again.
<LI><B>Arc lamps not turned on</B> <BR>
    The "NE" and "HGCD" keywords in the header indicates that either the
    neon or HgCd lamps are not fully turned on.
    When this happens, the arc is not reduced.
<LI><B>Best arc correlation = ...</B> <BR>
    The cross-correlation of the arc spectrum with the template arc spectrum
    was bad.  This problem also triggers BESTCORR as bad in the table (see above).
<LI><B>Big wavelength gap</B> <BR>
    Some arc lines were not found in the arc spectra, and there is a large
    gap in wavelength space without any lines.  This will produce a poor
    wavelength solution.  More arcs should be taken until this message
    does not appear.
<LI><B>Scattered light</B> <BR>
    There was a high baseline count rate on the CCD, and appears even
    between fibers.  This can most obviously occur if there are light
    sources in the CCD (such as the LED's we had for some time), or
    if the CCD's are warming up and generating dark current.
    There can also be a scattered light contribution just from a very
    bright sky, or if there are super-bright objects on some fibers that
    are scattering or bleeding light across the CCD.
<LI><B>Median spatial widths = ...</B> <BR>
    The spatial (X) widths of the fibers typically are gaussians with a
    sigma of 0.85 to 1.05 pixels.  If the sigma is larger than 1.10 pixels
    in any of the 4 quadrants of a CCD (lower-left, lower-right, upper-left,
    upper-right), then this warning is triggered.  It means
    that either the spectrographs are out of focus, or the slit-heads are
    not properly latched.  Note that these widths are computed for both
    the flat and science exposures (but not for arcs -- we compute the
    widths in the dispersion dimension for arcs).
<LI><B>Median wavelength widths = ...</B> <BR>
    The widths of the arc lines in the dispersion (Y) dimension typically
    are gaussians with a sigma of 0.90 to 1.10 pixels.
    If the sigma is larger than 1.10 pixels
    in any of the 4 quadrants of a CCD (lower-left, lower-right, upper-left,
    upper-right), then this warning is triggered.  It means
    that either the spectrographs are out of focus, or the slit-heads are
    not properly latched.
<LI><B>Too few sky fibers to model sky-sub variance</B> <BR>
    There are not enough good sky fibers on the CCD.  This will only happen
    if for some reason there were far fewer than the mandated 16 sky fibers
    on a CCD, or most of those fibers just happened to be dead fibers.
    You should never see this message.  If you do, the data is un-reducable.
<LI><B>Airmass range = ...</B> <BR>
    This warning is triggered if the airmass exceeds 2.5.  At such large
    airmasses, the atmospheric refraction terms are getting large and the
    sky background is bright.  The data is still usable, it's just not as
    good as taking data at lower airmass.
<LI><B>Large flexure flat<->science</B> <BR>
    There is a large shift (more than 0.15 pix) between the flat-field and
    the science exposure, presumably from flexure in the spectrographs.
    When this happens, another set of flat-fields (post-calibs) is
    recommended.  (However, don't bother to take a set of calibrations
    on a different night.  The Spectro-2D reductions never use calibrations
    from one night for science exposures on another.)
<LI><B>Whopping fiber at ....</B> <BR>
    The fibers listed have very bright objects that affect their neighbors
    on the CCD.  If the objects are bright enough (12th mag?), then this can
    trigger other warnings such as "scattered light".  I think it's safe
    to say that whopping fibers only show up when there has been a mistake
    made in the plate designs.  If you see this more than once on newly-designed
    plates, you should file a PR against the TARGET code.  (For example,
    Astuko found that some bright stars were incorrectly being targetted
    as galaxies; PR 2471.)
<LI><B>Bad sky residuals at ....</B> <BR>
    There is very poor sky-subtraction of the sky fibers at these wavelengths.
    This means that, somehow, there is excess light down the fibers that
    varies across the plate.  This could be due to a light source near the
    telescope, or possibly a bright, non-uniform sky.  The threshhold is
    set at chi=2.  Note that other, horrendous problems (like a warm CCD,
    scattered light, or out-of-focus spectrographs) could also trigger this.
    In that case, there should be relevant warning messages preceding this one.
<LI><B>Red Monster at ....</B> <BR>
    This warning is triggered if we see bad sky residuals (above) that
    is specifically in the wavelength range of about 6400-6600 Ang.
    We think this happens when the handpaddle is still plugged in,
    in which case the observers should unplug it immediately.
    The treshhold is set at chi=2, and the worst that we have ever seen
    is at about the level chi=6  The last time we definitively saw this was on
    plate 426 on 3/4 Dec 2000 (MJD 51882).
<LI><B>SOS disk is ...% full</B> <BR>
    The specified disk on sos.apo is more than 95% full.  This could be
    either the disk used to copy the raw sdR images from sdsshost.apo,
    or the disk used for SOS outputs (/data/spectro/spectrologs/$MJD).
</UL>

<H4><A NAME="outputs_log">Log files</A></H4>

<P>
If the reduction of an exposure is catastrophically bad, it may not
appear at all in the Son-of-Spectro table.  However, there should still
be a log file for this exposure on the sos.apo computer:
    <DL><DD><PRE>
    /data/spectro/spectrologs/$MJD/splog-$CAMERA-$EXPOSURE.log
    </PRE></DD></DL>
Reading this file should tell you what failed.  The first and last lines
of these files should contain "Started at" and "Finished at"
followed by timestamps.

<H4><A NAME="outputs_figure">S/N figures</A></H4>

<P>
A <B>median</B> signal-to-noise is computed for each object in the
wavelength ranges [4000,5500] Angstroms (synthetic g-band)
and [6910,8500] Angstroms (synthetic i-band).
We plot these S/N values versus the PHOTO fiber magnitudes, which were
measured in approximately a 3-arcsec diameter aperature (the same size
as our fibers).  If everything is working perfectly, then our S/N values
should correlate very well with these PHOTO magnitudes.

<P>
We determine whether a plate is "done" based upon the signal-to-noise
of the fainter objects on the plate.  We do this by fitting a line to
the (S/N)-vs.-magnitude plot in a specified wavelength range, then evaluating
this fit at g=20.2 mag (blue CCDs), and i=19.9 mag (red CCDs).
Approximately 10% of the main galaxy sample, 60% of the BRG's and 15% of
the QSO's are fainter than g=20.2.  Very few objects (1, 1, and 5%) are
fainter than i=19.9.

<P>
When the sky level is higher, we gain S/N more slowly at
the fainter magnitudes where we are sky-limited rather than photon-limited.
Without moon, we have typically found:
<DL><DD><PRE>
  log(S/N_g) = (zeropoint) - 0.31 * g
  log(S/N_i) = (zeropoint) - 0.31 * i
</PRE></DD></DL>
With partial moon, the slope steepens to -0.34 or worse.

<P>
The fitting regions are denoted on the plot with vertical dotted lines.
Arrows point to the evaluation of the fit on each of the 4 cameras, with
the top panels corresponding to the blue CCD's (synthetic g-band) and
the bottom panels corresponding to the red (synthetic r-band).
The thick blue line on the figure is only a meaningless, fixed reference line.

<P>
The right-hand figures plot the residuals of each object from the fit.
Symbol sizes on those right-hand plots indicate the magnitude of the
deviation from the fit line.  Symbol color is the same on the left
as on the right, so
<B><FONT COLOR="#00FF00">green</FONT></B>
objects have more flux and
<B><FONT COLOR="#FF0000">red</FONT></B>
ones less.
If the scale of the telescope is wrong, then you will see a radial drop-off
in flux (red points on the edge of the plate).
If you are observing too far over in air mass, then typically you correct
to first order with a scale change, but a quadropole is left in these
residuals.
If one spectrograph has problems, then this will show up as red points
in half of one of these figures.

<P>
Note that the (S/N)^2 totals listed in the table and the figure might
not exactly agree.  This is because the fitting to (S/N)-vs.-magnitude
is done on individual frames for the table, but on the summed S/N over
all frames for the figure.  The tabulated values are the ones we use
to declare a plate done.

<H2><A NAME="trouble">Trouble-shooting Son-of-Spectro</A></H2>

<P>
The Son-of-Spectro (SOS) reduction robot has proven to be quite robust.
However, if it appears to not be working one could check the following:
<OL>
<LI><B>Has a "loadCartridge" command been issued?</B><BR>
    If this has not been done from SOP, then there is no PLATE entry
    in the images.  This prevents SOS from reducing anything but bias
    and dark frames.
<LI><B>Is the cron job running?</B><BR>
    Log into "observer@sos.apo.nmsu.edu", and issue a "sos_status"
    command.  This should report that SOS is running.
    If not, then <A HREF="#launch">restart the cron job</A>.
<LI><B>Is the data being copied over?</B><BR>
    The raw data files should be copied from "sdsshost" to "sos.apo"
    in the /data/spectro/$MJD directory.  If it is not, then the disk
    may be full!  Or, the rsync command may not be working.
    This <B>could</B> be due to a rogue
    "aporsync" process sitting around.  The "sos_status" command will
    report any such processes.  If you suspect this as the
    problem, just kill that process.  It's a harmless thing to do, since
    SOS will just start it up again within a minute.
<LI><B>Are there old "lock" files sitting around?</B><BR>
    SOS generates "lock" files to prevent multiple processes from changing
    these files simultaneously.  The "sos_status" command will report
    all "lock" files and their last modification times.
    If any have been sitting around for several minutes or more,
    then something is wrong.  You should delete the file ending with ".lock".
    <B>However</B>, this could result in a corrupted "logfile*.fits".
<LI><B>Is anything amiss with running the scripts?</B><BR>
    Perhaps there is a communication problem between sdsshost.apo and sos.apo,
    or a problem running the code on sos.apo.  There is logging information
    written once per minute into the file
    <DL><DD><PRE>
    /data/spectro/spectrologs/sos.log
    </PRE></DD></DL>
    which may indicate such problems.
<LI><B>Is the logfile corrupted?</B><BR>
    This is probably the worst thing that could happen.  If the file
    <DL><DD><PRE>
    /data/spectro/spectrologs/$MJD/logfile-$MJD.fits
    </PRE></DD></DL>
    gets corrupted, then SOS will repeatedly crash.  One could just
    delete this file, which would basically wipe out all the previous
    reductions for that night from the web page.  Alternatively, one
    could delete all the raw and reduced data for that night from
    "sos.apo" (but not from sdsshost!!) :
    <DL><DD><PRE>
    % rm -rf /data/spectro/spectrologs/$MJD
    % rm -rf /data/spectro/$MJD
    </PRE></DD></DL>
    That might sound extreme, but SOS will simply start re-copying
    everything from "sdsshost" and re-build the reductions for the night.
    Obviously, this could take a couple of hours if its already late
    into the night.
</OL>

<H2><A NAME="rereduce">Re-Reducing (Failed) Exposures</A></H2>

<P>
As of version v4_7_1, there is a mechanism to re-reduce exposures
with "sos_redo".
You may need to do this if a reduction failed, or the pre-calibs failed
and SOS could not reduce the science exposures, or if you needed
to edit the sdR header information by putting entries in the sdReport
file.

<P>
It is fastest to only re-reduce a specific exposure number.
To force a re-reduction of exposure number 12345 on all 4 cameras
(whether it has already been reduced or not) use the EXPNUM option:
<DL><DD><PRE>
  % ssh sos.apo.nmsu.edu sos_redo expnum=12345
</PRE></DD></DL>
If you want to find and reduce only failed reductions for a plate
use the PLATE option.  This may take several more minutes because
all of the FITS headers for the night are parsed.
To re-reduce only missing exposures for plate 666:
<DL><DD><PRE>
  % ssh sos.apo.nmsu.edu sos_redo plate=666
</PRE></DD></DL>
The last exposure taken is not re-reduced unless explicitly told to
with the EXPNUM option.  Currently, either EXPNUM or PLATE must be
specified.

<P>
Note that science exposures for a plate cannot be reduced until both
flat and arc exposures have been successfully reduced for that same plate.

<HR>

<p>This is from version $Name$ of procedures.<p>

<ADDRESS> Maintained by
<A HREF="mailto:schlegel@astro.princeton.edu">David Schlegel</A>
and <A HREF="mailto:sburles@fnal.gov">Scott Burles</A>
</ADDRESS>

</BODY>
</HTML>

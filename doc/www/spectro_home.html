<HTML>
<HEAD>
<TITLE>Princeton SDSS Spectroscopy Home Page</TITLE>
</HEAD>

<BODY>

<BASE TARGET="_top">

<BODY>

<H1><CENTER>Princeton SDSS Spectroscopy Home Page</CENTER></H1>

<P>
This page should get SDSS Collaborators started using the spectra within
minutes.  To retrieve the data you need permissions set for copying data
from Princeton (<A HREF="#get_where">see below</A>).  Unfortunately, we
have not been able to copy recent data to the Fermilab computers, though
some older reductions are available there.
This page describes tools to view, query and use these data using IDL,
SuperMongo or IRAF.  There are also <A HREF="#summary">summary ASCII files</A>
that contain positions, magnitudes, classification information, and redshifts.

<P>
In this document:
<UL>
  <LI><A HREF="#plots">Some Nifty Plots</A>
  <LI><A HREF="#get_data">Getting the Reduced Data</A>
  <OL>
     <LI><A HREF="#platelist">Which Plates Are Reduced?</A>
     <LI><A HREF="#duplicates">Avoiding Duplicates</A>
     <LI><A HREF="#get_version">What Version of the Code Was Used?</A>
     <LI><A HREF="#get_where">Where Is the Data?</A>
     <LI><A HREF="#get_rsync">How to Keep Your Data Up-to-Date</A>
  </OL>
  <LI><A HREF="#summary">What Is the Summary File?</A>
  <LI><A HREF="#display">Looking at the Data</A>
  <OL>
     <LI><A HREF="#idlsetup">Setting Up IDL Tools</A>
     <LI><A HREF="#idldisplay">Displaying the Spectra From IDL</A>
     <LI><A HREF="#smdisplay">Displaying the Spectra From SM</A>
     <LI><A HREF="#irafdisplay">Displaying the Spectra From IRAF</A>
     <LI><A HREF="#irafphist">Pat Hall's IRAF SDSS Tasks</A>
  </OL>
  <LI><A HREF="#special">"Special" Plates</A>
  <LI><A HREF="#datamodel">What Is the Data Model?</A>
  <LI><A HREF="#targetflags">What Are the Target Flags?</A>
  <LI><A HREF="#vacuum">The Wavelengths Are in Vacuum!!??</A>
  <LI><A HREF="#problems">Problems</A>
  <OL>
     <LI><A HREF="#problems_known">Known Problems</A>
     <LI><A HREF="#problems_report">How to Report Problems</A>
  </OL>
</UL>

<P>
Related documents:
<UL>
  <LI><A HREF="idlspec2d_install.html">Installing idlspec2d the official way</A>
  <LI><A HREF="idlspec2d_reduce.html">Reducing <B>raw</B> spectroscopic data</A>
  <LI>Full documentation: <A HREF="idlspec2d_doc.html">idlspec2d</A>
  <LI>Full documentation: <A HREF="idlutils_doc.html">idlutils</A>
  <LI>Full documentation: <A HREF="goddard_doc.html">Goddard IDL utilities</A>
</UL>

<P>
Related web sites:
<UL>
  <LI><A HREF="http://www.sdss.org/">Official SDSS Web Site</A>
  <LI>The <A HREF="http://astro.Princeton.EDU/BBOOK/">"Black Book"</A>
      and the
      <A HREF="http://www.astro.princeton.edu/PBOOK/welcome.htm">
      "Project Book"</A>
  <LI><A HREF="http://www.astro.princeton.edu:81/">Princeton SDSS Web Site</A>
      (restricted access)
  <LI><A HREF="http://plate-mapper.apo.nmsu.edu:8020/topFrame.html">
      Plate Inventory Database</A> (restricted access)
  <LI><A HREF="http://www-sdss.fnal.gov:8000/~sdssdp/target/chunks.html">
      Fermi ``Chunk'' List</A> (restricted access)
  <LI><A HREF="http://sdss.fnal.gov:8000/~danvb/spectra/specids.html">
      Van den Berk's manual classifications</A> (restricted access)
  <LI><A HREF="http://sdss.fnal.gov:8000/qwg/spectra/specids.html">
      Van den Berk's manual classifications for EDR</A> (restricted access)
</UL>

<P>
Related mailing lists (restricted access):
<UL>
  <LI>Spectroscopic pipeline
      <A HREF="http://www.astro.princeton.edu:81/sdss-spectro/INDEX.html">
      (sdss-spectro)</A>
  <LI>Spectroscopic commissioning
      <A HREF="http://www.astro.princeton.edu:81/sdss-spcommish/INDEX.html">
      (sdss-spcommish)</A>
  <LI>Hand-written observing logs (imaging + spectroscopy)
      <A HREF="http://www.astro.princeton.edu:81/sdss-25mlog/INDEX.html">
      (sdss-25mlog)</A>
  <LI>Spectro auto-generated observing logs
      <A HREF="http://www.astro.princeton.edu:81/sdss-speclog/INDEX.html">
      (sdss-speclog)</A>;
      or <A HREF="http://sos.apo.nmsu.edu/logfile-current.html">current log</A>

</UL>

<HR>

<H2><A NAME="plots">Some Nifty Plots</A></H2>

<P>
Plot of <A HREF="platehist.ps">the cumulative number of survey-quality
spectra.</A>

<P>
Here are some nifty plots of only those objects within 2 degrees of the
equatorial plane:
<OL>
<LI><A HREF="zplot-main.ps">Pie diagram to z=0.15</A>
<LI><A HREF="zplot-brg.ps">Pie diagram to z=0.6</A>
<LI><A HREF="zplot-qso.ps">Pie diagram to z=5</A>
<LI><A HREF="zplot-log.ps">Logarithmically-spaced pie diagram</A>
</OL>
(On a PostScript previewer, turn off State->Antialias.)
The Milky Way is masked with dashed lines.  The MAIN galaxy sample are
black points, the luminous red galaxies (LRGs) that are not in MAIN are red,
and quasars are blue.

<H2><A NAME="get_data">Getting the Reduced Data</A></H2>

<H4><A NAME="platelist">Which Plates Are Reduced?</A></H4>

<P>
The SDSS will observe approximately 2000 plates by the end of
its 5 year survey.  Each plate is physically an aluminum disk 60 cm
in diameter that subtends 3 degrees on the sky.
640 fibers are plugged into each plate at the location of objects chosen from
the photometric survey, allowing us to spectroscopically observe 640
objects at time.  Typically, we integrate for 45 minutes on each plate.

<P>
Since plates are occasionally re-observed, the plate number plus the
observation date uniquely identifies an observation.  We track the
date with modified Julian date (MJD).  In these re-observations,
the optical fibers may be plugged into different holes, so fiber #1 on
plate 306 won't be the same on the MJD=51637 observation as on MJD=51690.

<P>
Therefore, PLATE + MJD + FIBERID uniquely determines a single observation
of a single object.  The TILE number uniquely determines a position on the
sky, and there are a few instances where two PLATEs are drilled for one TILE.

<P>
<A HREF="platelist.txt">This list of plates  (platelist.txt)
is auto-updated each day based upon which reductions have completed.</A>
To date, we have observed over 200 plates.
This list comes from a FITS file (<A HREF="platelist.fits">platelist.fits</A>)
which contains somewhat more information.

<P>
Aside from PLATE, TILE and MJD, this list contains the following:
<PRE>
RA       = Right ascension of plate center [J2000 degrees].
DEC      = Declination of plate center [J2000 degrees].
MAPNAME  = Mapping name for this plate; data with the same mapping name
          are always combined into one plate file, even if taken on
          different nights.
VERSLOG  = Version of SPECLOG product (spectroscopic log files).
VERSFLAT = Version of SPECFLAT product (spectroscopic pixel flats).
VERS2D   = Version of Spectro-2D code to reduce the individual frames.
VERSCOMB = Version of Spectro-2D code to combine frames into a plate file.
VERS1D   = Version of Princeton-1D code to measure redshifts.
VERSTARG = Version of Target code for selecting the objects on this plate.
CHUNKNAME= The name of the Target and tiling run which produced this plate.
SN2_G1   = (S/N)^2 per pixel at g=20.2 on spectrograph #1.
SN2_G2   = (S/N)^2 per pixel at g=20.2 on spectrograph #2.
SN2_R1   = (S/N)^2 per pixel at r=20.25 on spectrograph #1.
SN2_R2   = (S/N)^2 per pixel at r=20.25 on spectrograph #2.
SN2_I1   = (S/N)^2 per pixel at i=19.9 on spectrograph #1.
SN2_I2   = (S/N)^2 per pixel at i=19.9 on spectrograph #2.
N_GALAXY = The number of objects Princeton-1D called a galaxy.
N_QSO    = The number of objects Princeton-1D called a QSO.
N_STAR   = The number of objects Princeton-1D called a star.
N_UNKNOWN= The number of objects Princeton-1D declared spectroscopically 
           unknown (a ZWARNING flag is set)
N_SKY    = The number of sky fibers (almost always exactly 32)
STATUS2D = Status of Spectro-2D pipeline; "Done" if done.
STATUS1D = Status of Princeton-1D pipeline; "Done" if done.
QSURVEY  = Status flag set to 1 for the best observation of any tile on the sky
           that satifies the following: (S/N)^2 > 15 for G1,G2,I1,I2, and
           the target version cannot be "special" or "devel".
PUBLIC   = Name of public data release; presently plates are either not public,
           or part of the early data release (EDR).
</PRE>

<P>
The values of SN2 give an estimate of the signal-to-noise (per pixel) of a plate
at a fiducial magnitude.  The fiducials are set to g=20.2, r=20.25, i=19.9.
The measurement is of the signal-to-noise squared, per pixel, for an object
at that magnitude.  If all these values are > 13, then the plate is "good".
Plate 310 is "not good".  The first observation of plate 302
would be called "horrible".

<H4><A NAME="duplicates">Avoiding Duplicates</A></H4>

<P>
Selecting only those plates with QSURVEY=1 will yield non-duplicate
observations of tiles on the sky that meet the survey requirements
for signal-to-noise.  There still may be a few duplicate objects,
as some objects are put on multiple tiles for "quality assurance".
These duplicates can be identified with OBJTYPE="QA".  That OBJTYPE
column exists either in HDU #5 of the <A HREF="#datamodel">spPlate files</A>,
or in a column by that name in the <A HREF="#summary">spAll summary files</A>.

<H4><A NAME="get_version">What Version of the Code Was Used?</A></H4>

<P>
The version of the code used in the reductions is specified in the
header keywords VERS2D, VERSCOMB, VERS1D as described in the
<A HREF="#datamodel">data model</A>.

<P>
All these reductions were done using versions of the code tagged v4_7_x,
which represents a homogeneous set of reductions.

<H4><A NAME="get_where">Where Is the Data?</A></H4>

<P>
The spectroscopic data is reduced at Princeton, typically within 12 hours
of the data being taken.  These reductions are available directly from
Princeton as described below.  We have not been able to successfully mirror
these reductions on any Fermi machines.

<P>
At Princeton, the top-level directory for the reduced data is:
<DL><DD><PRE>
/u/dss/spectro
</PRE></DD></DL>
Older reductions exist at:
<DL><DD><PRE>
/u/dss/spectro_v4
</PRE></DD></DL>

<P>
Note that we have not been able to copy all these data to the Fermi machines.
Some fraction of these data are available at the following sites:
<DL><DD><PRE>
sdssdp3.fnal.gov:/data/dp3.p/data/schlegel/2d_v4_7 (some new reductions)
fsgi03.fnal.gov:/usr/sdss/data04/schlegel/2d_v4 (old reductions)
</PRE></DD></DL>

<P>
To obtain the data from Princeton you will need access to the "alfred"
account.  Send your SSH public key (in the file ".ssh/identity.pub") to
<A HREF="mailto:schlegel@astro.princeton.edu">schlegel@astro.princeton.edu</A>.
Once you have been added to the authorized_keys list for user "alfred",
then you can copy all 80 Gb of outputs with:
<DL><DD><PRE>
   rsync -arv --rsh="ssh" \
    alfred@sdssdata.princeton.edu:/u/dss/spectro/ .
</PRE></DD></DL>
Most people will only want the summary files, combined spectra, 1D outputs,
and log files (about 25 Gb):
<DL><DD><PRE>
   rsync -arv --rsh="ssh" --include "*/" \
    --include "platelist*" --include "spAll*" \ 
    --include "*spZ*.fits" --include "spPlate*.fits" \ 
    --include "*.log" --include "*.ps" \
    --exclude "*"  \
    alfred@sdssdata.princeton.edu:/u/dss/spectro/ .
</PRE></DD></DL>
</B>

<!--
<P>
This is approximately 25 Gb of data, which can be copied from Fermi with:
<DL><DD><PRE>
scp -r sdssdp3.fnal.gov:/data/dp3.p/data/schlegel/2d_v4_7 .
</PRE></DD></DL>
If you don't have permissions on this machine, contact your
<A HREF="http://www-sdss.fnal.gov:8000/guru/gurulist.html">local data guru</A>
or <A HREF="mailto:jen_a@fnal.gov">Jen Adelman at Fermi</A>.
-->

<P>
Each plate has three files associated with it:
<DL><DD><PRE>
$SPECTRO_DATA/$PLATE/spPlate-$PLATE-$MJD.fits
$SPECTRO_DATA/$PLATE/spZbest-$PLATE-$MJD.fits
$SPECTRO_DATA/$PLATE/spZall-$PLATE-$MJD.fits
</PRE></DD></DL>
where $SPECTRO_DATA refers to the top-level directory (spectro), and $PLATE
refers to a subdirectory with the plate name (e.g., 0301), and $MJD refers
to the date of observation (e.g., 52000).

<H4><A NAME="get_rsync">How to Keep Your Data Up-to-Date</A></H4>

<P>
These spectroscopic reductions are completely automated with the
Spectro Robot.  As data are taken at Apache Point, the data are copied
to Princeton, plan files are built that describe how to reduce the
data, and the reductions are batched on local and remote CPU's.
<!--
Once each day, these reduced data are synced with a Fermi mirror site.
-->
You can expect all spectroscopic observations to be reduced within 24 hours.

<!--
<P>
A number of plates have failed in these reductions.  Mostly, these are
the early data.  As we fix problems and reduce these plates, they will
be added to the above Fermi directory.
-->

<P>
An efficient way to keep your copy of these reductions current is to use
the Unix "rsync" command:
<DL><DD><PRE>
rsync -arv --rsh="ssh" alfred@sdssdata.princeton.edu:/u/dss/spectro/ .
</PRE></DD></DL>
You can use this to copy the data to your own computer in the first place.
If you run "rsync" again, it will copy any files that have been
changed or added.  Note that you need "ssh" to work without asking for a
pass-phrase for "rsync" to work as a cron job (see below) -- see your system
admin if you need help with that.

<!--
<P>
An older and more heterogeneous set of reductions are available on the
fsgi03 machine.  These were not kept up to date at Fermi after February 2001
due to problems with the fsgi03 machine.  You can copy over those reductions
by specifying my version of "rsync" on the remote machine:
<DL><DD><PRE>
rsync -arv --rsh="ssh" \
 --rsync-path=/afs/fnal.gov/files/home/room2/schlegel/bin/rsync \
 fsgi03.fnal.gov:/usr/sdss/data04/schlegel/2d_v4 .
</PRE></DD></DL>
-->

<P>
Finally, you could set up a "cron" job to update your copy of the data on
a daily basis.  This would be done by creating a cron table file (call it
"cron.table" in this example).  If you want to copy all 80 Gb of spectro
outputs, this file would look like:
<DL><DD><PRE>
15 3 * * * /usr/bin/rsync -arv --rsh="ssh" alfred@sdssdata.princeton.edu:/u/dss/spectro/ /my/directory
</PRE></DD></DL>
replacing "/my/directory" with your local data-directory name.
Most people will want only the following files (25 Gb of data):
<DL><DD><PRE>
15 3 * * * /usr/bin/rsync -arv --rsh="ssh" --include "*/" --include "platelist*" --include "spAll*" --include "*spZ*.fits" --include "spPlate*.fits" --include "*.log" --include "*.ps" --exclude "*" alfred@sdssdata.princeton.edu:/u/dss/spectro/ /my/directory
</PRE></DD></DL>
Finally, you may simply want the summary files:
<DL><DD><PRE>
15 3 * * * /usr/bin/rsync -arv --rsh="ssh" --include "platelist*" --include "spAll*" --exclude "*" alfred@sdssdata.princeton.edu:/u/dss/spectro/ /my/directory
</PRE></DD></DL>
Then load this "cron" job by typing:
<DL><DD><PRE>
crontab cron.table
</PRE></DD></DL>
This example will update your copy of the data at 3:15am every morning.
To stop this updating, unload the cron table with:
<DL><DD><PRE>
crontab -r
</PRE></DD></DL>

<H2><A NAME="special">"Special" Plates</A></H2>

<P>There are a number of "special" plates, designed for commissioning
either the hardware or target selection for the survey.  These plates are:
<UL>
<LI> <B>Plate 125-134, 160, 161 : Coma plates </B><BR>
     See
     <A HREF="http://ranger.phys.cmu.edu/users/merrelli/">
     Aaron Merrelli's web page</A>.<BR>
     These data were taken when the spectrographs were just being put
     together.  Only one spectrograph was on the telescope (with 320 fibers),
     and there was significant light contamination from LED's inside the
     instrument.<BR>
     Plate 133 was observed.
<LI> <B>Plate 135-159 : Early data plates </B><BR>
     These plates have the same caveats as for the Coma plate above.
     Descriptions of these early data and how to obtain raw and reduced
     spectra, can be found at:<BR>
<A HREF="http://www-sdss.fnal.gov:8000/spectrodoc/doc/www/spectra/list.html">
     http://www-sdss.fnal.gov:8000/spectrodoc/doc/www/spectra/list.html</A>
<LI> <B>Plates 162-185 : FASST plates </B><BR>
     These are test plates with astrometric stars.  Only engineering data
     was taken with these plates.
<LI> <B>Plate 231 : Reddening plate </B><BR>
     This plate was observed in marginal conditions on MJD 51455.
<LI> <B>Plates 318,319 : Faint M67 plates </B><BR>
     These plates were designed by Brian Yanny (318) and David Schlegel (319).
     See
     <A HREF="http://www.astro.princeton.edu:81/sdss-spcommish/msg.149.html">
     sdss-spcommish msg/149</A>
     and
     <A HREF="http://www.astro.princeton.edu:81/sdss-spcommish/msg.159.html">
     sdss-spcommish msg/159</A>.<BR>
     Plate 318 was observed on several occasions; plate 319 was never observed.
     Since the SPECTROPHOTO standards were really just random positions on
     the sky, the current reductions are probably garbage.
<LI> <B>Plate 320 : Faint QSO plate </B><BR>
     See
     <A HREF="http://www.astro.princeton.edu:81/sdss-spcommish/msg.206.html">
     sdss-spcommish msg/206</A> <BR>
     This plate has not been observed.
<LI> <B>Plate 321 : M67 velocity standards</B><BR>
     See
     <A HREF="http://www.astro.princeton.edu:81/sdss-spcommish/msg.206.html">
     sdss-spcommish msg/206</A> <BR>
     This plate was observed and used to test the precision of measuring
     velocities.
<LI> <B>Plates 322-324 : Stellar locus plates</B><BR>
     See
     <A HREF="http://www.astro.princeton.edu:81/sdss-spcommish/msg.206.html">
     sdss-spcommish msg/206</A> <BR>
     The two fainter plates, 323 and 324, have been observed.
</UL>

<H2><A NAME="summary">What Is the Summary File?</A></H2>

<P>
I've attempted to generate one monstrous file with all the spectroscopic
and photometric outputs (but not the actual images or spectra).
This is a FITS binary table called "spAll.fits".
At present, there are three versions of this file as follows:
<OL>
   <LI><B>spAll.fits</B> - All spectroscopic data taken to date (approximately 226,000 spectra).
   <LI><B>spAll-qsurvey.fits</B> - spAll trimmed to only those plates
       that comprise unique
       tiles with survey quality S/N (e.g., where QSURVEY=1 in the
       <A HREF="#platelist">platelist file</A>)
   <LI><B>spAll-public.fits</B> - spAll trimmed to only those plates
       that should be in the Early Data Release (including repeat observations
       that are survey quality)
</OL>

<P>
In addition, I've also made ASCII files with the most relevant quantities
that one may wish to search on.  This file is "spAll*.dat", and is basically
a stripped-down version of "spAll*.fits" for those FITS-challenged astronomers.

<P>
These photometric outputs were assembled by Daniel Eisenstein and Mike Blanton.
Where the PHOTO data does exist, they are selected from the tsObj files
used to drill the plates, <B>not the most recent calibrations</B>.
This is what Eisenstein & Blanton call their "skyVersion==0" outputs.

<P>
Note that some of the photometric outputs were never recovered!
Of 226,560 reduced spectra, we are missing PHOTO data for 8581 spectra.
Since plate 324, we are missing PHOTO data for 110 of 169,600 spectra.
We are missing no PHOTO data for spectra in the Early Data Release.

<P>
If you have access to the Princeton computers,
these trimmed tsObj files can be found at:
<PRE>
  sdssdata.princeton.edu:/u/dss/spectro/plates
</PRE>

<P>
Another technical point: the <A HREF="#targetflags">target flags</A>
have been over-written with those found in the plPlugMapM files,
since Eisenstein reports that they are incorrect in many of the tsObj files.
Also, the distance between the spectroscopic target and the matched PHOTO
output is stuffed into the TEXTURE[0] column.

<H2><A NAME="display">Looking at the Data</A></H2>

<P>
Since standard FITS files are used, there are many ways to access these
data.  Below are descriptions of specially-written IDL and SM code for
looking at the data.  IRAF, TCL, and other tools could also be used.
If you write any such tools, it would be useful to make them available
to the collaboration by posting them on this site.

<P>
The absolute simplest way to look at the data is to use SAOimage or XIMTOOL
to display the plate images (spPlate*.fits), which will show you all 640
spectra on a plate at once.

<H4><A NAME="idlsetup">Setting Up IDL Tools</A></H4>

<P>
If you have someone maintaining survey code at your institution
(i.e., at Princeton using a Linux box), you can set up the tools
by simply typing:
<DL><DD><PRE>
source /u/products/etc/sdssfue.csh
setup idlspec2d
</PRE></DD></DL>

<P>
If you need to install the code yourself, you need two products:
"idlutils", and "idlspec2d".  If you wish to reduce the raw data
from scratch, you will also need a third product called "specflat".
These will work
on any platform (Linux, SGI, Solaris, etc) as long as you also have
an IDL license.  You must have "idl" in your path, and the IDL_PATH
environment variable should already be set.  At Princeton, you would type:
<DL><DD><PRE>
setenv IDL_DIR  /usr/peyton/common/licensed/idl
setenv IDL_PATH  .:+{$IDL_DIR}/lib
alias idl $IDL_DIR/bin/idl
</PRE></DD></DL>

<P>
You can download and set up these utilities in just a few minutes
from a couple of tar files.  Click on the following files to download them:
<UL>
<LI><A HREF="idlutils-v4_8_1.tar">idlutils-v4_8_1.tar</A>
<LI><A HREF="idlspec2d-v4_8_1.tar">idlspec2d-v4_8_1.tar</A>
<LI><A HREF="specflat-v1_2.tar">specflat-v1_2.tar</A>
</UL>
This last tar file you will only need in the unlikely case that you
are reducing the raw data.

<P>
If you've put these files in your home directory, then unpack and build
them as follows:
<DL><DD><PRE>
tar xf idlutils*.tar
tar xf specflat*.tar
tar xf idlspec2d*.tar
setenv IDLUTILS_DIR $HOME/idlutils
setenv SPECFLAT_DIR $HOME/specflat
setenv IDLSPEC2D_DIR $HOME/idlspec2d
setenv IDL_PATH  +{$IDLUTILS_DIR}/goddard/pro:{$IDL_PATH}
setenv IDL_PATH  +{$IDLUTILS_DIR}/pro:{$IDL_PATH}
setenv IDL_PATH  +{$IDLSPEC2D_DIR}/pro:{$IDL_PATH}
set path = ( $path {$IDLUTILS_DIR}/bin {$SPECFLAT_DIR}/bin {$IDLSPEC2D_DIR}/bin )
cd $IDLUTILS_DIR
evilmake all
cd $IDLSPEC2D_DIR
evilmake all
</PRE></DD></DL>

<P>
Extensive documentation exists for the commands described below, in
the file:
<DL><DD><PRE>
<A HREF="idlspec2d_doc.html">$IDLSPEC2D_DIR/doc/www/idlspec2d_doc.html</A>
</PRE></DD></DL>

<H4><A NAME="idldisplay">Displaying the Spectra From IDL</A></H4>

<P>
First, set up the "idlutils" and "idlspec2d" software, as described above.

<P>
You need to set an environment variable that points to the top-level
directory of the data.  At Princeton, this would be:
<DL><DD><PRE>
setenv SPECTRO_DATA /u/dss/spectro
</PRE></DD></DL>

<P>
Start IDL with:
<DL><DD><PRE>
idl
</PRE></DD></DL>

<P>
Then from within IDL, you can display individual spectra as following.
To display plate 401, fiber 100:
<DL><DD><PRE>
IDL> <A HREF="idlspec2d_doc.html#PLOTSPEC">plotspec</A>, 401, 100
</PRE></DD></DL>
The spectrum is shown in white, the errors in red (except masked points
are set to zero), and the best-fit eigenspectrum in blue.
The mouse buttons will zoom in (left), recenter (center), or zoom out (right).
The frame can be saved as a PostScript file by selecting File->WriteEPS
from the left-hand corner.

<P>
Make the same plot, but boxcar-smooth the spectrum:
<DL><DD><PRE>
IDL> <A HREF="idlspec2d_doc.html#PLOTSPEC">plotspec</A>, 401, 100, nsmooth=10
</PRE></DD></DL>

<P>
Some plates are observed on multiple nights.  To select one of the two
observations of plate 306:
<DL><DD><PRE>
IDL> <A HREF="idlspec2d_doc.html#PLOTSPEC">plotspec</A>, 306, 20, mjd=51690
</PRE></DD></DL>

<P>
You can write the spectrum to an ASCII file as follows:
<DL><DD><PRE>
IDL> <A HREF="idlspec2d_doc.html#WRITESPEC">writespec</A>, 401, 100
</PRE></DD></DL>
The default file name will be "spec-0401-51788-100.dat".  This can
be changed by setting the FILENAME keyword:
<DL><DD><PRE>
IDL> <A HREF="idlspec2d_doc.html#WRITESPEC">writespec</A>, 401, 100, filename='junk.dat'
</PRE></DD></DL>

<P>
Quitting IDL:
<DL><DD><PRE>
IDL> exit
</PRE></DD></DL>

<P>
<B>For IDL pundits</B>, the general-purpose routine for reading the data
is the <A HREF="idlspec2d_doc.html#READSPEC">READSPEC</A> procedure.

<H4><A NAME="smdisplay">Displaying the Spectra From SM</A></H4>

<P>
The SM tools were written by Michael Strauss, Vijay Narayanan, and Robert
Lupton.
<UL>
<LI> <A HREF="spectro_sm/README.spectro">Click here for their README file.</A>
<LI> <A HREF="spectro_sm.tar">Click here for their tar file.</A>
</UL>
Problems and suggestions should be reported to Michael Strauss
(<A HREF="mailto:strauss@astro.princeton.edu">strauss@astro.princeton.edu</A>).

<P>
You will need the latest version of SM (version SM2_4_8), which supports
FITS extensions.  If you have a valid SM license, you or your system admin
should be able to install this (see the bottom of
Michael's <A HREF="spectro_sm/README.spectro">README file</A>.
At Princeton, the new version is available on either "tanuki" or "moonshine"
by executing:
<DL><DD><PRE>
~rhl/sm/src/sm
</PRE></DD></DL>

<P>
At Princeton, you could type the following to display plate 306 fiber 100,
then overplot the best-fit template:
<DL><DD><PRE>
ssh moonshine
setenv SPECTRO_DATA /u/dss/spectro
setenv IDLSPEC2D_DIR /u/schlegel/idlspec2d
cd ~strauss/spectro_sm/release
~rhl/sm/src/sm
dev x11
input_new spectro.sm
define idl 1
plotspec 306 100
   t
</PRE></DD></DL>

<H4><A NAME="irafdisplay">Displaying the Spectra From IRAF</A></H4>

<P>
Described below is the most basic method of plotting the spectra from IRAF.
Better tools will be posted on this page as they are available.

<P>
Use the splot task in the noao.onedspec package.  For example:

<PRE>
cl> noao
no> onedspec
on> splot spPlate-0311-51665.fits[0][*,1]   # plot fiber 1's flux
on> splot spPlate-0311-51665.fits[1][*,1]   # plot fiber 1's inverse variance **
on> splot spPlate-0311-51665.fits[0]        # interactively plot fluxes:
Image line/aperture to plot (0:) (1): 65    # start w/fiber 65; use # to choose
        # a new fiber, or ( and ) to move down and up by 1 in number; q to quit
on> phelp splot                             # for detailed help on splot
on> phelp onedspec                          # for summary of other tasks, e.g.:
on> specplot spPlate-0311-51665.fits[0][*,1],spPlate-0311-51665.fits[0][*,2]
        # stack and plot fibers 1 and 2 without overlapping
</PRE>

<P>
If you are looking at early reductions, you may need to make a local copy of
the spectral FITS file and delete the WCSDIM header keyword before using splot:
<PRE>
on> hedit my_spPlate-0311-51665.fits wcsdim del+ add- show+ update+ verify-
</PRE>

<H4><A NAME="irafphist">Pat Hall's IRAF SDSS Tasks</A></H4>

<P>
Pat Hall has written an IRAF package, PHIST, for displaying SDSS spectra.
It does not yet have the functionality of the IDL or SM tools, but includes
the following tasks:
<PRE>
lplots - overplot wavelengths of emission / absorption lines for given z
 sbqsx - sample task for converting SX .tbl output to formatted ASCII
sbqsx2 - another task for converting SX .tbl output to formatted ASCII
 splat - interactively SPLOT a specific observation (plate+mjd+fiber) 
 splet - non-interactively SPECPLOT an observation and its error spectrum 
</PRE>

Here's the README file on how to retrieve & install the package
(at Princeton you can just read /u/pathall/IRAF/PHIST/phist.hlp):

<PRE>
        PHIST -- Pat Hall's IRAF SDSS Tasks

v.1     001206  Read "phist.hlp" ("phelp phist opt=sys" in IRAF) for an
        introduction.  Entire package available as a compressed tarfile
        from <A HREF="http://astro.princeton.edu/~pathall/phist1.tar.gz">http://astro.princeton.edu/~pathall/phist1.tar.gz</A>
        To install, enter the proper pathnames in "phist.cl" and
        "phist.hd", load the IRAF "softools" package, and type
        "mkhelpdb root.hd helpdb.mip", deleting the old helpdb.mip
        if necessary.  See "phist.hlp" for how to include
        the package in your default IRAF startup.
</PRE>

<H2><A NAME="datamodel">What Is the Data Model?</A></H2>

<P>
The first FITS file (spPlate*.fits) contains the following: <BR>
<PRE>
HDU #0 = Flux in units of 10^(-17) erg/cm/s/Ang [FLOAT]
HDU #1 = Inverse variance (1/sigma^2) for the above [FLOAT]
HDU #2 = AND mask [32-bit INT]
HDU #3 = OR mask [32-fit INT]
HDU #4 = Wavelength dispersion in pixels [FLOAT]
HDU #5 = Plug-map structure from plPlugMapM file [BINARY FITS TABLE]
</PRE>

The following header keywords are of interest: <BR>
<PRE>
PLATEID = Plate ID
TILEID  = Tile ID
MAPID   = Fiber mapper ID
NAME    = Name of target: Plate ID, MJD, Fiber mapper rerun
COEFF0  = Central wavelength (log10-Angstroms) of first pixel
COEFF1  = Wavelength range of each pixel (log-10 Angstroms)
RADEG   = Right ascension of plate center (degrees)                     
DECDEG  = Declination of plate center (degrees)                         
EXPT_B1 = b1 camera exposure time (seconds)              
EXPT_B2 = b2 camera exposure time (seconds)              
EXPT_R1 = r1 camera exposure time (seconds)              
EXPT_R2 = r2 camera exposure time (seconds)              
EXPTIME = Minimum of exposure times for all cameras      
VERS2D  = Version of idlspec2d for 2D reduction
VERSCOMB= Version of idlspec2d for combining multiple spectra
VERS1D  = Version of idlspec2d for 1D reduction
</PRE>

<P>
The second file (spZbest*.fits) is the Princeton-1D output file.
Early reductions have a single HDU, which is the FITS binary table
described below.  Reductions with version v4_7_0+ also include
a 2nd HDU which is the best-fit eigen-spectrum for each object.
These can be regenerated from the tabular information, but for
convenience I've explicitly computed them.

<P>
The columns in the first HDU are as follows: <BR>
<PRE>
PLATE      Plate number
TILE       Tile number
MJD        Modified Julian date of observation
FIBERID    Fiber ID (1 to 640)
OBJID      4-element PHOTO ID of targetted object: run, re-run, column, ID
OBJTYPE    Why this object was targetted
PLUG_RA    Object RA
PLUG_DEC   Object DEC
CLASS      Spectro classification: GALAXY, QSO, STAR, SKY;
           versions prior to v4_7 will also use UNKNOWN; later versions set
           the ZWARNING flag
SUBCLASS   Spectro sub-classification; presently only used for STARs with the
           catagories: O, B, A, F, K, M, L, Carbon_DQ, Carbon, WD, CV, sdM
Z          Redshift; if the ZWARNING flag is nonzero, then assume that this
           redshift is incorrect
Z_ERR      Redshift error; at present, not well determined
RCHI2      Reduced chi^2 for best fit
DOF        Degrees of freedom for best fit
RCHI2DIFF  Difference in reduced chi^2 of best solution to 2nd best solution
TFILE      Template file in $IDLSPEC2D_DIR/templates
TCOLUMN    Columns to use in template file (0-indexed); unused values set to -1
NPOLY      Number of polynomial terms used in conjuction with TFILE
THETA      Eigenvalue coefficients for each column in template file + each polynomial term
VDISP      Velocity dispersion, only computed for galaxies (km/sec)
VDISP_ERR  Error in VDISP (km/sec)
WAVEMIN    Minimum observed wavelength for this object (Angstroms)
WAVEMAX    Maximum observed wavelength for this object (Angstroms)
WCOVERAGE  Amount of wavelength coverage in log-10(Angstroms)
ZWARNING   A flag set for bad redshift fits in place of calling CLASS=UNKNOWN.
           The following bits may be set:
           0 = Sky fiber
           1 = Too little wavelength coverage (WCOVERAGE < 0.18)
           2 = Chi^2 is too close to chi^2 for the next best fit (within 0.01)
           3 = Synthetic spectrum is negative (only set for stars and QSO's)
           4 = Fraction of points above 5 sigma is too large (> 5%)
           5 = Chi^2 minimum was at the edge of the redshift-fitting range,
               resulting in Z_ERR being set to -1.
SN_MEDIAN  Median S/N for all good pixels
FRACNSIGMA Fraction of pixels deviant by more than N sigma, where N=[1,2,...10]
COUNTS_SPECTRO  5-element array of total flux in each of the 5 PHOTO filters;
                the units are such that this equals 1 at 0th magnitude;
                convert to magnitudes with -2.5 * LOG_10(COUNTS_SPECTRO);
                the u-band and z-band counts should not be used
COUNTS_SYNTH    Same as COUNTS_SPECTRO, but measured using the best-fit
                synthetic eigen-spectrum rather than the actual data points
COUNTS_SKY      (Placeholder.)
ANYANDMASK Mask bits which are set if any pixels for an object's ANDMASK
           have that bit set.
ANYORMASK  Mask bits which are set if any pixels for an object's ORMASK
           have that bit set.
SPEC1_G    (S/N)^2 at g=20.20 for spectrograph #1 (same value for 320 fibers)
SPEC1_R    (S/N)^2 at r=20.25 for spectrograph #1 (same value for 320 fibers)
SPEC1_I    (S/N)^2 at i=19.90 for spectrograph #1 (same value for 320 fibers)
SPEC2_G    (S/N)^2 at g=20.20 for spectrograph #2 (same value for 320 fibers)
SPEC2_R    (S/N)^2 at r=20.25 for spectrograph #2 (same value for 320 fibers)
SPEC2_I    (S/N)^2 at i=19.90 for spectrograph #2 (same value for 320 fibers)
</PRE>

<P>
There are two masks, an "AND" mask and an "OR" mask.  The spectra
are constructed from 3 or more 15-minute observations, and the "AND" mask
bits are set if that bit is set for each and every input observation.
The "OR" mask bits are set if that bit is set for any of the observations.
Usually, I only look at the "AND" mask.

<P>
The mask bits are set as follows: <BR>
<PRE>
 0 NOPLUG          Fiber not listed in plugmap file
 1 BADTRACE        Bad trace from routine TRACE320CRUDE
 2 BADFLAT         Low counts in fiberflat
 3 BADARC          Bad arc solution
 4 MANYBADCOLUMNS  >10% pixels are bad columns
 5 MANYREJECTED    >10% pixels are rejected in extraction
 6 LARGESHIFT      Large spatial shift between flat and object pos'n
 7 BADSKYFIBER     Sky Fiber shows extreme residuals
 8 NEARWHOPPER     Within 2 fibers of a whopping fiber (inclusive)
10 SMEARIMAGE      Smear available for red and blue cameras
11 SMEARHIGHSN     S/N sufficient for full smear fit
12 SMEARMEDSN      S/N only sufficient for scaled median fit
16 NEARBADPIXEL    Bad pixel within 3 pixels of trace
17 LOWFLAT         Flat field less than 0.5
18 FULLREJECT      Pixel fully rejected in extraction (INVVAR=0)
19 PARTIALREJECT   Some pixels rejected in extraction
20 SCATTEREDLIGHT  Scattered light significant
21 CROSSTALK       Cross-talk significant
22 NOSKY           Sky level unknown at this wavelength (INVVAR=0)
23 BRIGHTSKY       Sky level > flux + 10*(flux error)
                   AND sky > 1.25 * median(sky,99 pixels)
24 NODATA          No data available in combine B-spline (INVVAR=0)
25 COMBINEREJ      Rejected in combine B-spline
26 BADFLUXFACTOR   Low flux-calibration or flux-correction factor
27 BADSKYCHI       Chi^2 > 4 in sky residuals at this wavelength
28 REDMONSTER      Contiguous region of bad chi^2 in sky residuals

</PRE>

When low numbered bits (<16) are set, those will be set for half
of the spectra -- either the blue or red spectrograph.  The higher-numbered
bits (>=16) are set for individual pixels.

<P>
<B>Which mask bits are important?</B>  The conditions that are considered
very bad are already used to set the errors to infinity for the
effected pixels (specifically, the inverse variance is set to zero).
The most useful mask bit to look at is BRIGHTSKY, which indicates
when the sky is so bright relative to the object that perhaps one
shouldn't trust any of the object flux there.  Our reported errors
are meant to include sky-subtraction errors, but there are instances
(particularly around 5577) where these errors may be untrustworthy.

<H2><A NAME="targetflags">What Are the Target Flags?</A></H2>

<P>
The target selection sets bits in two flags called PRIMTARGET and SECTARGET.
An object can have multiple bits set.  For example, if the target selection
code determined that an object was both a QSO_SKIRT and a STAR_WHITE_DWARF,
then two bits will be set.  The value of PRIMTARGET in this example will
be 2^4 + 2^19 = 524304.

<P>
Let's say you want to find all objects either targetted as a carbon star,
or spectroscopically classified as one.  All this information is in the
summary file "spAll.fits".  From IDL, one could search for these objects
and print their PLATE, MJD, and FIBERID as follows:
<DL><DD><PRE>
IDL> a = mrdfits('spAll.fits',1) ; This file should be in your current directory
IDL> i = where((a.primtarget AND 2L^14) NE 0)
IDL> print, transpose([[a[i].plate],[a[i].mjd],[a[i].fiberid]])

     [ Prints list of objects targetted as a Carbon star.]

IDL> i = where(strmatch(a.subclass, 'Carbon*'))
IDL> print, transpose([[a[i].plate],[a[i].mjd],[a[i].fiberid]])

     [ Prints list of objects spectroscopically called a Carbon star.]
</PRE></DD></DL>

<P>
Now plot the first object that was found above:
<DL><DD><PRE>
IDL> i=0 & <A HREF="idlspec2d_doc.html#PLOTSPEC">plotspec</A>, a[i].plate, a[i].fiberid, mjd=a[i].mjd
</PRE></DD></DL>

<P>
The PRIMTARGET bit values are as follows (in hex and decimal):
<PRE>
  QSO_HIZ           = 0x1          = bit # 0 =        1
  QSO_CAP           = 0x2          = bit # 1 =        2
  QSO_SKIRT         = 0x4          = bit # 2 =        4
  QSO_FIRST_CAP     = 0x8          = bit # 3 =        8
  QSO_FIRST_SKIRT   = 0x10         = bit # 4 =       16
  QSO_MAG_OUTLIER   = 0x2000000    = bit #25 = 33554432
  QSO_REJECT        = 0x20000000   = bit #29 =536870912
  GALAXY_RED        = 0x20         = bit # 5 =       32
  GALAXY_RED_II     = 0x4000000    = bit #26 = 67108864
  GALAXY            = 0x40         = bit # 6 =       64
  GALAXY_BIG        = 0x80         = bit # 7 =      128
  GALAXY_BRIGHT_CORE= 0x100        = bit # 8 =      256
  ROSAT_A           = 0x200        = bit # 9 =      512
  ROSAT_B           = 0x400        = bit #10 =     1024
  ROSAT_C           = 0x800        = bit #11 =     2048
  ROSAT_D           = 0x1000       = bit #12 =     4096
  ROSAT_E           = 0x8000000    = bit #27 =134217728
  STAR_BHB          = 0x2000       = bit #13 =     8192
  STAR_CARBON       = 0x4000       = bit #14 =    16384
  STAR_BROWN_DWARF  = 0x8000       = bit #15 =    32768
  STAR_SUB_DWARF    = 0x10000      = bit #16 =    65536
  STAR_CATY_VAR     = 0x20000      = bit #17 =   131072
  STAR_RED_DWARF    = 0x40000      = bit #18 =   262144
  STAR_WHITE_DWARF  = 0x80000      = bit #19 =   524288
  STAR_PN           = 0x10000000   = bit #28 =268435456
  SERENDIP_BLUE     = 0x100000     = bit #20 =  1048576
  SERENDIP_FIRST    = 0x200000     = bit #21 =  2097152
  SERENDIP_RED      = 0x400000     = bit #22 =  4194304
  SERENDIP_DISTANT  = 0x800000     = bit #23 =  8388608
  SERENDIP_MANUAL   = 0x100000     = bit #24 = 16777216
  QSO_MAG_OUTLIER   = 0x200000     = bit #25 = 33554432
  GALAXY_RED_II     = 0x400000     = bit #26 = 67108864
  ROSAT_E           = 0x800000     = bit #27 =134217728
  STAR_PN           = 0x1000000    = bit #28 =268435456
  QSO_REJECT        = 0x2000000    = bit #29 =536870912
</PRE>

<P>
The SECTARGET bit values are as follows (in hex and decimal):
<PRE>
  LIGHT_TRAP        = 0x1          = bit # 0 =        1
  REDDEN_STD        = 0x2          = bit # 1 =        2
  TEST_TARGET       = 0x4          = bit # 2 =        4
  QA                = 0x8          = bit # 3 =        8
  SKY               = 0x10         = bit # 4 =       16
  SPECTROPHOTO_STD  = 0x20         = bit # 5 =       32
  GUIDE_STAR        = 0x40         = bit # 6 =       64
  BUNDLE_HOLE       = 0x80         = bit # 7 =      128
  QUALITY_HOLE      = 0x100        = bit # 8 =      256
  HOT_STD           = 0x200        = bit # 9 =      512
</PRE>

<P>
These flag values were copied from the "target" module files
"common/arTargetType.h" and "etc/diags.tcl".  (There doesn't actually
appear to be any single file tracks all of these flags!)

<H2><A NAME="vacuum">The Wavelengths Are in Vacuum!!??</A></H2>

<P>
Yes, the data are stored using <B>vacuum</B> wavelengths.  This makes sense
for quasologists.  But most optical astronomers know the wavelengths of
transitions as measured at S.T.P., which is how the CRC lists them for
any transitions redward of 2000 Angstroms.

<P>
The IAU standard for conversion from air to vacuum wavelengths is given
in Morton (1991, ApJS, 77, 119).  For vacuum wavelengths (VAC) in Angstroms,
convert to air wavelength (AIR) via:<BR>
<PRE>
  AIR = VAC / (1.0 + 2.735182E-4 + 131.4182 / VAC^2 + 2.76249E8 / VAC^4)
</PRE>

<P>
Below, I've listed the vacuum wavelength of some transitions:
<PRE>
 Air       Vacuum
 --------  --------
 4861.363  4862.721  H-beta
 4958.911  4960.295  [O III]
 5006.843  5008.239  [O III]
 6548.05   6549.86   [N II]
 6562.801  6564.614  H-alpha
 6583.45   6585.27   [N II]
 6716.44   6718.29   [S II]
 6730.82   6732.68   [S II]
</PRE>

<H2><A NAME="problems">Problems</A></H2>

<H4><A NAME="problems_known">Known Problems</A></H4>

<P>
Here is a list of the most offensive known problems in Spectro-2D as
of version v4_7_0 (19 March 2001):
<PRE>
-------------------------------------------------------------------------------
Failed plates:

Plate 187-51454 has no good b2 arc, then fails in combining
Plate 192-51461 has no good b2 arc, then fails in combining
Plate 194-51462 has no good b2 arc, then fails in combining
Plate 204-51455 has no good b1,b2,r2 arcs
Plate 213-51578 has no good b2 arcs
Plate 218-51641 has no good b2 arc, then fails in combining
Plate 231-51455 has no good r1 arcs
Plate 235-51462 fails because the only b2 arc is saturated
Plate 283-51660 has no good b1,b2 arcs
Plate 296-51578 has no good b2 arcs
Plate 318 special plate needs edited plug-map files in order to run
Plate 324-51616 only has one science exposure, so won't combine
Plate 560-52045 only has one science exposure, so won't combine

-------------------------------------------------------------------------------
Plates that will never reduce:

Plate 182-51703 crashed in 2D -- No sky fibers found; too many whopping fibers?
    This a FFAST plate with 12th magnitude stars.  The one
    exposure of 900 secs is saturated.  To top it off, the
    plugmap file has no sky fibers allocated.
Plate 191-51454 has no arcs
Plate 284-51934 has no good arcs (flat-field screen was not closed for arcs)
Plate 317-51589 has no flats or arcs
Plate 347-51694 has only 1 science exposure, which is saturated.
Plate 347-51701 has only 1 science exposure, which is not enough to combine.

-------------------------------------------------------------------------------
Bad problems:

Plate 202/51441 has some wrong z=4.3 qso's.
Plate 260/51612 looks like funny fluxing in the blue at around 4000 Ang,
                probably due to very low S/N
Plate 354/51792 taken during moon.
Plate 426/51882 has the Red Monster at 6400-6550 Ang in exp #7366-7367
Fibers 375,376 have bad sky residuals on many plates, e.g.
      on plates 360, 396, 418, 429, 437.  This appears to be a problem
      with the pixel-masks.

-------------------------------------------------------------------------------
</PRE>

<H4><A NAME="problems_report">How to Report Problems</A></H4>

<P>
Problems can be reported via the bug database at:
<DL><DD><PRE>
<A HREF="http://www.astro.princeton.edu:81/cgi-bin/gnatsweb.pl">
http://www.astro.princeton.edu:81/cgi-bin/gnatsweb.pl</A>
</PRE></DD></DL>
File bugs about the extracted spectra against the category "idlspec2d",
and about the redshifts or template-fitting against "spectroBS".
Before filing a problem report (PR), first search the bug database to
make sure no one else has already reported that problem.

<HR>
<A HREF="http://astro.princeton.edu/~schlegel/">David Schlegel</A>,
<A HREF="mailto:schlegel@astro.princeton.edu">schlegel@astro.princeton.edu</A>
</ADDRESS>

</BODY>
</HTML>


\title{idlspec2d dataflow}
\author{Stephen Bailey, Julian Bautista, David Schlegel}
\date{\today}

\documentclass[12pt]{article}

\usepackage{amsmath}

\begin{document}
\maketitle

\abstract{
This note documents the idlspec2d algorithm dataflow.
The majority of the code was written by David Schlegel;
the purpose of this document is to succinctly describe each of the steps.
}

%-------------------------------------------------------------------------
\section{Overview}

BOSS has 2 spectrographs with 500 fibers each, grouped in 25 bundles of 20
fibers each.  The light is split into a blue channel and a red channel, for
a total of 4 CCD images per exposure. The CCD $y$ coordinate is the spectral
dispersion direction (larger $y$ is larger $\lambda$) and
larger $x$ is larger fiber number, though the spectral ``traces'' in
$y$~{\it vs.}~$x$ are curved and do not exactly align with CCD columns.

{\it Raw electrons} are extracted from the CCD images using row-by-row extractions similar to Horne~1986 by fitting Gaussians plus a polynomial
background to each CCD row for each bundle of 20 fibers.

{\it Fiber flats} correct for fiber-to-fiber variations by comparing the
differences between fibers equally illuminated by a smooth flat lamp spectrum.

{\it Sky model} is derived from flat fielded electrons of sky fibers and then
interpolated to the locations of every science fiber and subtracted.

{\it Flux calibration} vectors model the instrument and atmospheric throughput
per exposure by comparing standard star spectra to a set of models of known
flux.

{\it Flux correction} vectors adjust for flux mis-calibrations with low-order
polynomials per-fiber per-exposure to make different exposures of the same object consistent with each other.

{\it Flux distortion} vectors model variations in the throughput
across the focal plane.

Putting these together --- \newline
``flat fielded sky subtracted electrons'' in spFrame:
\begin{equation}
F_e = \mathrm{electrons} / (\mathrm{superflat} \cdot \mathrm{fiberflat}) -
    \mathrm{skymodel}
\end{equation}
become the ``calibrated flux'' in spCFrame:
\begin{equation}
F = (F_e / \mathrm{calib}) \cdot
    \mathrm{fluxcorr} \cdot \mathrm{fluxdistort}
\end{equation}

The following sections describe each of these steps in detail.

%-------------------------------------------------------------------------
\section{Extracted electrons to calibrated flux}

\subsection{Extraction}

\subsection{Fiber flats and trace locations}

\subsection{Wavelength solution and PSF shape}

\subsection{Sky subtraction}

\subsection{Flux calibration}

\subsection{Flux correction}

Individual exposures are initially flux calibrated with no constraint that the same object has the same flux across different exposures.  Emperical ``fluxcorr'' vectors are broadband corrections to bring the different exposures into alignment for each object prior to coaddition.  In DR13 and prior, these were implemented for each spectrum by minimizing
\begin{equation}
    \chi^2_i = \sum_\lambda {
        (f_{i\lambda} - f_{\mathrm{ref},\lambda} / a_{i\lambda} )^2 \over
        (\sigma_{i\lambda}^2 - \sigma_{\mathrm{ref},\lambda}^2 / a_{i\lambda}^2)
        }
\end{equation}
where $f_{i\lambda}$ is the flux of exposure $i$ at wavelength $\lambda$;
$f_{\mathrm{ref},\lambda}$ is the flux of the selected reference exposure;
and $a_{i\lambda}$ are low order Legendre polynomials.
%--- If you want more detail:
 The number of polynomial terms is dynamic, up to
 a maximum of 5 terms.  Higher order terms are added only if they improve
 the $\chi^2$ by 5 compared to one less term.
This approach is biased toward small $a_{i\lambda}$ since that inflates the denominator to reduce the $\chi^2$.

For DR14, we solve the fluxcorr vectors relative to a common weighted coadd $F_\lambda$ which is treated as noiseless compared to the individual exposures.
\begin{equation}
    \chi^2_i = \sum_\lambda {
        (f_{i\lambda} - F_\lambda / a_{i\lambda})^2 \over
        \sigma_{i\lambda}^2
        }
\end{equation}
We additionally include an emperically tuned prior that $a_{i\lambda} \sim 1$ to avoid large excursions in the solution for very low signal-to-noise data.

 The DR14 fluxcorr terms are Chebychev polynomials instead of Legendre for no
 good reason.  We actually solve for $((f - F a)/\sigma)^2$ and then return $1/a$.
 The prior is weighted by the data weights such that the relative strength of
 the prior vs. the data is approximately independent of S/N.  I'm not convinced
 that is the best thing to do but it worked better than having a fixed
 strength prior.


\subsection{Flux distortion}

The {\it flux distortion} vectors are parameterized in terms of magnitude
(i.e.~log-flux) that are achromatic with $x$, $y$, $x^2$, $y^2$, $xy$,
where those are linear coordinates XFOCAL,YFOCAL from the plugmap.
There are also chromatic terms that scale as
$\tilde \lambda = 1-(5070/\lambda)^2$,
since that function gives an equal effect between 3900 and 5070~\AA\
as between 5070 ang 9000~\AA.
There are also magnitude offsets as a function of spectrograph ID,
and a chromatic offset as a function of spectrograph ID.  The 13 parameters are:
\begin{equation}
\begin{split}
    F_\mathrm{new} &= F_\mathrm{orig}
        \left(1 + a_0 s_1 + a_1 s_2 \right) \mathrm{exp} \left( \right. \\
&            a_2 x + a_3 y + a_4 x y + a_5 x^2 + a_6 y^2 + \\
&            a_7 \tilde \lambda x + a_8 \tilde \lambda y + \\
&             a_9 \tilde \lambda s_1 + a_{10} \tilde \lambda s_2 +
             a_{11} \tilde \lambda^2 s_1 + a_{12} \tilde \lambda^2 s_2
        \left. \right)
\end{split}
\end{equation}
where $s_1$=1 if specid=1 else 0 and $s_2$=1 if specid=2 else 0.

Only \textsc{SPECTROPHOTO\_STD} or \textsc{REDDEN\_STD} objects are used to compute the flux distortion. The procedure minimizes differences between spectro-flux and photometry (CALIBFLUX). For now, only g, r and i-bands are used.

%-------------------------------------------------------------------------
\section{Coaddition}

%-------------------------------------------------------------------------
\section{Code}

\begin{tabular}{lp{30mm}p{30mm}}
Code & Inputs & Outputs \\
\hline
spreduce2d  & spPlan2d  & \\
\hline
  spreduce    & sdR \newline plPlugMapM & \\
\hline
    spcalib     &       & spArc \newline spFlat \newline spFrame \\
\end{tabular}

\end{document}
